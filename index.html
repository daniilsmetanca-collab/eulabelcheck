<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>EU LABEL CHECK — EU Food Label Regulatory Screening Tool</title>
<meta name="description" content="Free regulatory pre-screening tool for EU food labels. 22 checks across 11 EU regulations and directives classify findings as structurally decidable, conditionally triggered, evidence-dependent, or interpretive risk. EUR-Lex linked.">
<meta property="og:title" content="EU LABEL CHECK — EU Food Label Screening Tool">
<meta property="og:description" content="Screen food labels against 11 EU regulations and directives. Consequence archetypes, truth-type classification, Nutri-Score estimation. Free, private, no login.">
<meta property="og:type" content="website">
<meta property="og:url" content="https://daniilsmetanca-collab.github.io/eu-label-check/">
<meta name="twitter:card" content="summary">
<meta name="author" content="Daniil Smetanca — MSc Food Safety, Wageningen University & Research">
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='20' fill='%230c2340'/><text x='50' y='68' text-anchor='middle' font-family='system-ui' font-weight='bold' font-size='52' fill='%231a8a6e'>C</text></svg>">
<link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700&family=JetBrains+Mono:wght@400;500&family=Instrument+Serif:ital@0;1&display=swap" rel="stylesheet">
<style>
:root {
  --brand: #0c2340;
  --brand-mid: #1a3a5c;
  --accent: #1a8a6e;
  --accent-light: #22b88a;
  --accent-glow: rgba(26, 138, 110, 0.12);
  --pass: #16a34a;
  --pass-bg: #f0fdf4;
  --pass-border: #bbf7d0;
  --flag: #d97706;
  --flag-bg: #fffbeb;
  --flag-border: #fde68a;
  --block: #dc2626;
  --block-bg: #fef2f2;
  --block-border: #fecaca;
  --info: #2563eb;
  --info-bg: #eff6ff;
  --info-border: #bfdbfe;
  --surface: #ffffff;
  --bg: #f6f7f9;
  --bg-alt: #eef0f4;
  --border: #dfe3ea;
  --border-light: #eceef2;
  --text: #111827;
  --text-2: #4b5563;
  --text-3: #9ca3af;
  --font: 'DM Sans', system-ui, sans-serif;
  --serif: 'Instrument Serif', Georgia, serif;
  --mono: 'JetBrains Mono', monospace;
  --r: 8px;
  --r-lg: 12px;
  --shadow-sm: 0 1px 2px rgba(0,0,0,0.04);
  --shadow: 0 2px 8px rgba(0,0,0,0.06);
  --shadow-lg: 0 8px 30px rgba(0,0,0,0.1);
}

html { scroll-behavior: smooth; scroll-padding-top: 70px; }
*, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: var(--font);
  color: var(--text);
  background: var(--bg);
  line-height: 1.55;
  -webkit-font-smoothing: antialiased;
  min-height: 100vh;
}

/* ── NAV ── */
.nav {
  background: var(--brand);
  position: sticky; top: 0; z-index: 100;
  border-bottom: 1px solid rgba(255,255,255,0.08);
}
.nav-inner {
  max-width: 1080px; margin: 0 auto;
  padding: 14px 28px;
  display: flex; align-items: center; justify-content: space-between;
}
.nav-logo {
  font-size: 20px; font-weight: 700; color: #fff; letter-spacing: -0.3px;
}
.nav-logo em { color: var(--accent-light); font-style: normal; }
.nav-sub { font-size: 11px; color: rgba(255,255,255,0.4); font-family: var(--mono); letter-spacing: 0.8px; text-transform: uppercase; }

/* ── HERO ── */
.hero {
  max-width: 1080px; margin: 0 auto; padding: 40px 28px 20px;
}
.hero h1 {
  font-family: var(--serif); font-size: 36px; font-weight: 400; color: var(--brand); letter-spacing: -0.5px; line-height: 1.2;
}
.hero h1 em { font-style: italic; color: var(--accent); }
.hero-sub {
  margin-top: 10px; font-size: 15px; color: var(--text-2); max-width: 680px; line-height: 1.6;
}
.hero-badges {
  margin-top: 16px; display: flex; flex-wrap: wrap; gap: 8px;
}
.badge {
  display: inline-flex; align-items: center; gap: 5px;
  padding: 4px 12px; border-radius: 100px;
  font-size: 11px; font-weight: 600; letter-spacing: 0.3px; text-transform: uppercase;
  background: var(--bg-alt); color: var(--text-2); border: 1px solid var(--border);
}
.badge .dot { width: 6px; height: 6px; border-radius: 50%; background: var(--accent); }
a.badge:hover { border-color: var(--accent); background: var(--accent-glow); color: var(--accent); }

/* ── LAYOUT ── */
.main { max-width: 1080px; margin: 0 auto; padding: 0 28px 60px; }

/* ── TABS ── */
.tab-bar {
  display: flex; gap: 0; border-bottom: 2px solid var(--border); margin-bottom: 28px; margin-top: 8px;
}
.tab {
  padding: 12px 20px; font-size: 13px; font-weight: 600; color: var(--text-3);
  cursor: pointer; border-bottom: 2px solid transparent; margin-bottom: -2px;
  transition: all 0.15s; background: none; border-top: none; border-left: none; border-right: none;
  font-family: var(--font);
}
.tab:hover { color: var(--text-2); }
.tab.active { color: var(--accent); border-bottom-color: var(--accent); }
.tab .tab-dot { display:inline-block;width:6px;height:6px;border-radius:50%;background:var(--pass);margin-left:5px;vertical-align:middle;opacity:0;transition:opacity 0.2s; }
.tab .tab-dot.filled { opacity:1; }

.tab-panel { display: none; }
.tab-panel.active { display: block; }

/* ── CARDS ── */
.card {
  background: var(--surface); border: 1px solid var(--border); border-radius: var(--r-lg);
  padding: 24px; margin-bottom: 20px; box-shadow: var(--shadow-sm);
}
.card-head {
  font-size: 14px; font-weight: 600; color: var(--brand); margin-bottom: 16px;
  padding-bottom: 10px; border-bottom: 1px solid var(--border-light);
  display: flex; align-items: center; gap: 10px;
}
.card-head .icon {
  width: 28px; height: 28px; border-radius: 6px; display: flex; align-items: center; justify-content: center;
  font-size: 14px; background: var(--accent-glow); color: var(--accent);
}

/* ── FORM ── */
.fg { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
.fg.three { grid-template-columns: 1fr 1fr 1fr; }
.fg .full { grid-column: 1 / -1; }

.field label {
  display: block; font-size: 11px; font-weight: 600; color: var(--text-2);
  text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 5px;
}
.field input, .field select, .field textarea {
  width: 100%; padding: 9px 12px; border: 1px solid var(--border); border-radius: var(--r);
  font-family: var(--font); font-size: 13px; color: var(--text); background: #fff;
  transition: border-color 0.15s, box-shadow 0.15s;
}
.field input:focus, .field select:focus, .field textarea:focus {
  outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-glow);
}
.field textarea { resize: vertical; min-height: 70px; }
.field .hint { font-size: 11px; color: var(--text-3); margin-top: 3px; }

/* ── ALLERGEN GRID ── */
.allergen-grid {
  display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 6px;
}
.allergen-item {
  display: flex; align-items: center; gap: 8px; padding: 7px 10px;
  border: 1px solid var(--border-light); border-radius: var(--r); font-size: 13px; color: var(--text-2);
  cursor: pointer; transition: all 0.12s; background: #fff;
}
.allergen-item:hover { border-color: var(--accent); background: var(--accent-glow); }
.allergen-item input { accent-color: var(--accent); width: 15px; height: 15px; }
.allergen-item.detected { border-color: var(--flag); background: var(--flag-bg); }

/* ── NUTRITION TABLE ── */
.nutri-grid { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 10px; }
.nutri-grid .field input { text-align: right; }

/* ── BUTTONS ── */
.btn-row { display: flex; gap: 10px; margin-top: 16px; flex-wrap: wrap; }
.btn {
  padding: 11px 24px; border: none; border-radius: var(--r); font-family: var(--font);
  font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.15s;
  display: inline-flex; align-items: center; gap: 6px;
}
.btn-primary { background: var(--accent); color: #fff; }
.btn-primary:hover { background: var(--accent-light); transform: translateY(-1px); box-shadow: var(--shadow); }
.btn-ghost { background: transparent; color: var(--text-2); border: 1px solid var(--border); }
.btn-ghost:hover { background: var(--bg); }

/* ── RESULTS ── */
#resultsPanel { display: none; }
#resultsPanel.visible { display: block; }

.summary-grid {
  display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 24px;
}
.stat-card {
  background: var(--surface); border: 1px solid var(--border); border-radius: var(--r-lg);
  padding: 18px; text-align: center; box-shadow: var(--shadow-sm);
}
.stat-card .stat-label { font-size: 10px; text-transform: uppercase; letter-spacing: 0.8px; color: var(--text-3); font-weight: 600; }
.stat-card .stat-val { font-size: 28px; font-weight: 700; font-family: var(--mono); margin: 6px 0 2px; }
.stat-card .stat-sub { font-size: 11px; color: var(--text-3); }
.stat-card.s-pass .stat-val { color: var(--pass); }
.stat-card.s-flag .stat-val { color: var(--flag); }
.stat-card.s-block .stat-val { color: var(--block); }
.stat-card.s-risk .stat-val { color: var(--brand); }

.verdict-bar {
  padding: 14px 20px; border-radius: var(--r-lg); margin-bottom: 24px;
  font-size: 14px; font-weight: 600; display: flex; align-items: center; gap: 10px;
}
.verdict-bar.v-pass { background: var(--pass-bg); border: 1px solid var(--pass-border); color: var(--pass); }
.verdict-bar.v-flag { background: var(--flag-bg); border: 1px solid var(--flag-border); color: var(--flag); }
.verdict-bar.v-block { background: var(--block-bg); border: 1px solid var(--block-border); color: var(--block); }

/* ── CHECK ITEMS ── */
.checks { display: flex; flex-direction: column; gap: 8px; }
.chk {
  background: var(--surface); border: 1px solid var(--border); border-radius: var(--r-lg);
  overflow: hidden; box-shadow: var(--shadow-sm); transition: border-color 0.15s;
}
.chk:hover { border-color: #ccc; }
.chk-head {
  display: grid; grid-template-columns: 36px 1fr 72px; gap: 12px; align-items: center;
  padding: 14px 18px; cursor: pointer;
}
.chk-icon {
  width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center;
  font-weight: 700; font-size: 15px;
}
.chk-icon.pass { background: var(--pass-bg); color: var(--pass); }
.chk-icon.flag { background: var(--flag-bg); color: var(--flag); }
.chk-icon.block { background: var(--block-bg); color: var(--block); }
.chk-icon.na { background: var(--bg-alt); color: var(--text-3); }

.chk-info { min-width: 0; }
.chk-name { font-size: 14px; font-weight: 600; color: var(--text); }
.chk-preview { font-size: 12px; color: var(--text-3); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-top: 2px; }
.chk-conf { font-size: 11px; font-family: var(--mono); color: var(--text-3); text-align: right; }

.chk-body {
  display: none; padding: 0 18px 16px 66px; border-top: 1px solid var(--border-light);
}
.chk.open .chk-body { display: block; padding-top: 14px; }
.chk-row { display: flex; gap: 8px; margin-bottom: 10px; font-size: 13px; }
.chk-row strong { min-width: 110px; color: var(--text); flex-shrink: 0; }
.chk-row span { color: var(--text-2); }

.disclaimer {
  margin-top: 32px; padding: 16px 20px; background: var(--bg-alt); border-radius: var(--r-lg);
  font-size: 12px; color: var(--text-3); line-height: 1.6; border: 1px solid var(--border-light);
}
.disclaimer strong { color: var(--text-2); }

/* ── FOOTER ── */
.footer {
  max-width: 1080px; margin: 0 auto; padding: 32px 28px; text-align: center;
  font-size: 11px; color: var(--text-3); border-top: 1px solid var(--border-light);
}

/* ── RESPONSIVE ── */
@media (max-width: 768px) {
  .hero h1 { font-size: 26px; }
  .fg, .fg.three { grid-template-columns: 1fr; }
  .nutri-grid { grid-template-columns: 1fr 1fr; }
  .summary-grid { grid-template-columns: 1fr 1fr; }
  .tab { padding: 10px 14px; font-size: 12px; }
  .chk-head { grid-template-columns: 32px 1fr; }
  .chk-conf { display: none; }
  #howItWorks > div:first-child { grid-template-columns: 1fr !important; }
  #methGrid { grid-template-columns: 1fr !important; }
}

/* ── PRINT ── */
@media print {
  .nav { position: static; }
  .tab-bar, .btn-row, .form-section { display: none !important; }
  #resultsPanel { display: block !important; }
  .chk-body { display: block !important; padding-top: 8px !important; }
  .chk { break-inside: avoid; }
  body { background: #fff; }
}
</style>
</head>
<body>

<nav class="nav"><div class="nav-inner">
  <div class="nav-logo">EU Label Check</div>
  <div class="nav-sub">EU Food Label Regulatory Screening</div>
</div></nav>

<div class="hero">
  <h1>Screen your food label against <em>EU regulatory requirements</em></h1>
  <p class="hero-sub">A free, open-source pre-assessment tool for food business operators, quality managers, and regulatory professionals. Identify compliance issues, flag where expert judgement is needed, and map the evidence required - across 11 EU regulations and directives, instantly, in your browser.</p>
  <div class="hero-badges">
    <a href="https://eur-lex.europa.eu/eli/reg/2011/1169/oj/eng" target="_blank" rel="noopener" class="badge" style="text-decoration:none"><span class="dot"></span>Reg. 1169/2011 (FIC)</a>
    <a href="https://eur-lex.europa.eu/eli/reg/2006/1924/oj/eng" target="_blank" rel="noopener" class="badge" style="text-decoration:none"><span class="dot"></span>Reg. 1924/2006 (Claims)</a>
    <a href="https://eur-lex.europa.eu/eli/reg/2019/787/oj/eng" target="_blank" rel="noopener" class="badge" style="text-decoration:none"><span class="dot"></span>Reg. 2019/787 (Spirits)</a>
    <a href="https://eur-lex.europa.eu/eli/reg/2013/1308/oj/eng" target="_blank" rel="noopener" class="badge" style="text-decoration:none"><span class="dot"></span>Reg. 1308/2013 (Wine)</a>
    <a href="https://eur-lex.europa.eu/eli/dir/2011/91/oj/eng" target="_blank" rel="noopener" class="badge" style="text-decoration:none"><span class="dot"></span>Dir. 2011/91/EU (Lot)</a>
    <a href="https://eur-lex.europa.eu/eli/reg/2012/1151/oj/eng" target="_blank" rel="noopener" class="badge" style="text-decoration:none"><span class="dot"></span>Reg. 1151/2012 (GI)</a>
    <a href="https://eur-lex.europa.eu/eli/reg/2015/2283/oj/eng" target="_blank" rel="noopener" class="badge" style="text-decoration:none"><span class="dot"></span>Reg. 2015/2283 (Novel Food)</a>
    <a href="https://eur-lex.europa.eu/eli/reg/2018/848/oj/eng" target="_blank" rel="noopener" class="badge" style="text-decoration:none"><span class="dot"></span>Reg. 2018/848 (Organic)</a>
    <a href="https://eur-lex.europa.eu/eli/reg/2003/1829/oj/eng" target="_blank" rel="noopener" class="badge" style="text-decoration:none"><span class="dot"></span>Reg. 1829/2003 (GMO)</a>
    <a href="https://eur-lex.europa.eu/eli/dir/2005/29/oj/eng" target="_blank" rel="noopener" class="badge" style="text-decoration:none"><span class="dot"></span>Dir. 2005/29/EC (UCPD)</a>
    <a href="https://eur-lex.europa.eu/eli/dir/2002/46/oj/eng" target="_blank" rel="noopener" class="badge" style="text-decoration:none"><span class="dot"></span>Dir. 2002/46/EC (Supplements)</a>
  </div>
  <div style="margin-top:20px;display:flex;gap:10px;flex-wrap:wrap">
    <a href="#formStart" class="btn btn-primary" style="text-decoration:none">Start Screening</a>
    <a href="#howItWorks" class="btn btn-ghost" style="text-decoration:none">How it works</a>
    <a href="#methodology" class="btn btn-ghost" style="text-decoration:none">Methodology</a>
  </div>
</div>

<!-- HOW IT WORKS -->
<div id="howItWorks" style="max-width:1080px;margin:0 auto;padding:0 28px 20px">
  <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:16px">
    <div class="card" style="text-align:center;padding:24px 20px">
      <div style="width:36px;height:36px;border-radius:8px;background:var(--accent-glow);display:flex;align-items:center;justify-content:center;margin:0 auto 10px"><svg width="18" height="18" fill="none" stroke="var(--accent)" stroke-width="2"><rect x="2" y="2" width="14" height="14" rx="2"/><line x1="5" y1="6" x2="13" y2="6"/><line x1="5" y1="9" x2="11" y2="9"/><line x1="5" y1="12" x2="9" y2="12"/></svg></div>
      <div style="font-size:14px;font-weight:600;color:var(--brand);margin-bottom:6px">1. Enter product data</div>
      <div style="font-size:13px;color:var(--text-2)">Fill in your product details across 5 sections: identity, labelling, ingredients, nutrition, and claims.</div>
    </div>
    <div class="card" style="text-align:center;padding:24px 20px">
      <div style="width:36px;height:36px;border-radius:8px;background:var(--accent-glow);display:flex;align-items:center;justify-content:center;margin:0 auto 10px"><svg width="18" height="18" fill="none" stroke="var(--accent)" stroke-width="2"><circle cx="9" cy="9" r="7"/><polyline points="6,9 8,11 12,7"/></svg></div>
      <div style="font-size:14px;font-weight:600;color:var(--brand);margin-bottom:6px">2. Regulatory screening</div>
      <div style="font-size:13px;color:var(--text-2)">Up to 22 automated checks classify findings as structurally decidable, conditionally triggered, evidence-dependent, or interpretive risk.</div>
    </div>
    <div class="card" style="text-align:center;padding:24px 20px">
      <div style="width:36px;height:36px;border-radius:8px;background:var(--accent-glow);display:flex;align-items:center;justify-content:center;margin:0 auto 10px"><svg width="18" height="18" fill="none" stroke="var(--accent)" stroke-width="2"><path d="M4,2 L14,2 L14,16 L4,16 Z"/><line x1="7" y1="5" x2="11" y2="5"/><line x1="7" y1="8" x2="11" y2="8"/><line x1="7" y1="11" x2="10" y2="11"/></svg></div>
      <div style="font-size:14px;font-weight:600;color:var(--brand);margin-bottom:6px">3. Situation analysis</div>
      <div style="font-size:13px;color:var(--text-2)">Get consequence archetypes (not just a score), evidence requirements, and article-level legal references. Export as PDF or JSON.</div>
    </div>
  </div>
  <div style="background:var(--info-bg);border:1px solid var(--info-border);border-radius:var(--r-lg);padding:14px 20px;margin-top:16px;font-size:13px;color:var(--info);display:flex;align-items:start;gap:10px">
    <svg width="16" height="16" fill="none" stroke="var(--info)" stroke-width="2" style="flex-shrink:0;margin-top:2px"><circle cx="8" cy="8" r="7"/><line x1="8" y1="5" x2="8" y2="9"/><circle cx="8" cy="11.5" r="0.5" fill="var(--info)"/></svg>
    <span><strong>Privacy:</strong> All compliance processing happens locally in your browser. No product data is sent to any server. No cookies, no tracking, no account required. Fonts are loaded from Google Fonts on page load (standard CDN request); no product information is included in that request.</span>
  </div>
</div>

<!-- METHODOLOGY -->
<div id="methodology" style="max-width:1080px;margin:0 auto;padding:0 28px 20px">
  <div class="card" style="padding:28px 28px 24px">
    <div style="font-size:11px;text-transform:uppercase;letter-spacing:0.8px;color:var(--text-3);font-weight:600;margin-bottom:6px">Methodology</div>
    <div style="font-size:18px;font-weight:700;color:var(--brand);margin-bottom:20px">How Validation Works</div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px" id="methGrid">

      <div style="background:var(--bg);border-radius:var(--r-lg);padding:20px;border:1px solid var(--border-light)">
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px">
          <div style="width:32px;height:32px;border-radius:8px;background:var(--accent-glow);display:flex;align-items:center;justify-content:center;flex-shrink:0"><svg width="16" height="16" fill="none" stroke="var(--accent)" stroke-width="2"><path d="M2,3 h12 M2,7 h8 M2,11 h10 M2,15 h6"/></svg></div>
          <div style="font-size:14px;font-weight:600;color:var(--brand)">Regulatory Mapping</div>
        </div>
        <p style="font-size:13px;color:var(--text-2);line-height:1.65">Every check maps to specific articles, annexes, and recitals of EU legislation. References were verified against consolidated texts on EUR-Lex (February 2026). The Legal Basis tab links directly to each regulation.</p>
      </div>

      <div style="background:var(--bg);border-radius:var(--r-lg);padding:20px;border:1px solid var(--border-light)">
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px">
          <div style="width:32px;height:32px;border-radius:8px;background:var(--accent-glow);display:flex;align-items:center;justify-content:center;flex-shrink:0"><svg width="16" height="16" fill="none" stroke="var(--accent)" stroke-width="2"><circle cx="8" cy="8" r="6"/><path d="M8,5 v4 l3,2"/></svg></div>
          <div style="font-size:14px;font-weight:600;color:var(--brand)">Allergen Detection</div>
        </div>
        <p style="font-size:13px;color:var(--text-2);line-height:1.65">Ingredients are scanned against keyword libraries for all 14 Annex II categories. Each uses multiple synonyms (e.g. "Milk" matches: milk, lactose, casein, whey, cream, butter, cheese, yogurt, ghee). Detected allergens are cross-referenced against declared ones.</p>
      </div>

      <div style="background:var(--bg);border-radius:var(--r-lg);padding:20px;border:1px solid var(--border-light)">
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px">
          <div style="width:32px;height:32px;border-radius:8px;background:var(--accent-glow);display:flex;align-items:center;justify-content:center;flex-shrink:0"><svg width="16" height="16" fill="none" stroke="var(--accent)" stroke-width="2"><rect x="2" y="2" width="12" height="12" rx="2"/><path d="M5,8 h6 M8,5 v6"/></svg></div>
          <div style="font-size:14px;font-weight:600;color:var(--brand)">Finding Classification</div>
        </div>
        <p style="font-size:13px;color:var(--text-2);line-height:1.65">Each finding is classified by <strong>severity</strong> (<span style="color:var(--pass);font-weight:600">PASS</span>, <span style="color:var(--flag);font-weight:600">FLAG</span>, <span style="color:var(--block);font-weight:600">BLOCK</span>) and by <strong>truth-type</strong>: <span style="font-weight:600">Structural</span> (decidable from inputs), <span style="font-weight:600">Trigger</span> (does this rule apply?), <span style="font-weight:600">Evidence</span> (needs external verification), or <span style="font-weight:600">Interpretive</span> (consumer perception / Art. 7 risk). The report headline maps findings to <strong>consequence archetypes</strong> - what an enforcement authority would likely do - rather than presenting a single compliance score.</p>
      </div>

      <div style="background:var(--bg);border-radius:var(--r-lg);padding:20px;border:1px solid var(--border-light)">
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px">
          <div style="width:32px;height:32px;border-radius:8px;background:rgba(220,38,38,0.08);display:flex;align-items:center;justify-content:center;flex-shrink:0"><svg width="16" height="16" fill="none" stroke="var(--block)" stroke-width="2"><circle cx="8" cy="8" r="6"/><line x1="6" y1="6" x2="10" y2="10"/><line x1="10" y1="6" x2="6" y2="10"/></svg></div>
          <div style="font-size:14px;font-weight:600;color:var(--brand)">Limitations</div>
        </div>
        <p style="font-size:13px;color:var(--text-2);line-height:1.65">Rule-based validation against user input only. Cannot verify: nutritional analysis accuracy, actual composition, permitted additive categories per food type (Annex II, Reg. 1333/2008), national implementing measures, physical label design or font measurements, or GI technical file conformity. Nutri-Score is estimated using the 2023 algorithm but is not official without Santé Publique France registration. Final responsibility rests with the FBO (Art. 8).</p>
      </div>

    </div>
    <div style="margin-top:16px;padding-top:14px;border-top:1px solid var(--border-light);font-size:12px;color:var(--text-3)">
      <strong style="color:var(--text-2)">Author:</strong> <a href="https://www.linkedin.com/in/daniil-smetanca" target="_blank" rel="noopener" style="color:var(--accent);text-decoration:none">Daniil Smetanca</a> - MSc Student Food Safety, Wageningen University & Research
    </div>
  </div>
</div>

<div id="formStart"></div>

<div class="main">
  <div class="form-section">
    <div class="tab-bar">
      <button class="tab active" onclick="switchTab(0)">Product<span class="tab-dot" id="td0"></span></button>
      <button class="tab" onclick="switchTab(1)">Labeling<span class="tab-dot" id="td1"></span></button>
      <button class="tab" onclick="switchTab(2)">Ingredients & Allergens<span class="tab-dot" id="td2"></span></button>
      <button class="tab" onclick="switchTab(3)">Nutrition<span class="tab-dot" id="td3"></span></button>
      <button class="tab" onclick="switchTab(4)">Claims & Other<span class="tab-dot" id="td4"></span></button>
      <button class="tab" onclick="switchTab(5)">Legal Basis</button>
    </div>

    <!-- TAB 0: PRODUCT -->
    <div class="tab-panel active" id="tab0">
      <div class="card">
        <div class="card-head"><span class="icon">1</span> Product Identity</div>
        <div class="fg">
          <div class="field"><label>Product Name *</label><input id="f_name" placeholder="e.g. Organic Tomato Soup"></div>
          <div class="field"><label>Company / FBO *</label><input id="f_company" placeholder="e.g. GoodFood BV"></div>
          <div class="field"><label>Food Category</label>
            <select id="f_cat">
              <option value="">Select...</option>
              <option value="Dairy">Dairy</option>
              <option value="Bakery">Bakery & Cereals</option>
              <option value="Meat">Meat & Poultry</option>
              <option value="Fish_seafood">Fish & Seafood</option>
              <option value="Fruit_veg">Fruit & Vegetables</option>
              <option value="Ready_meal">Ready Meals / Prepared Foods</option>
              <option value="Snacks">Snacks & Confectionery</option>
              <option value="Sauces">Sauces, Dressings & Condiments</option>
              <option value="Beverage_non_alc">Non-Alcoholic Beverages</option>
              <option value="Spirit">Spirit Drinks</option>
              <option value="Wine">Wine</option>
              <option value="Beer">Beer</option>
              <option value="Supplement">Food Supplements</option>
              <option value="Infant">Infant / Young Child Food</option>
              <option value="Frozen">Frozen Foods</option>
              <option value="Other">Other</option>
            </select>
          </div>
          <div class="field"><label>Subcategory / Specific Type</label><input id="f_subcat" placeholder="e.g. Gouda, Sourdough bread, Gin"></div>
          <div class="field"><label>Net Quantity</label><input id="f_qty" placeholder="e.g. 500 g, 1 L, 330 ml"></div>
          <div class="field"><label>Packaging Type</label>
            <select id="f_pkg">
              <option value="prepacked">Prepacked</option>
              <option value="non_prepacked">Non-prepacked</option>
              <option value="distance">Distance selling (online)</option>
            </select>
          </div>
          <div class="field"><label>ABV (% vol) - if alcoholic</label><input id="f_abv" type="number" step="0.1" placeholder="Leave blank if non-alcoholic"></div>
          <div class="field"><label>Target Markets</label><input id="f_markets" placeholder="e.g. NL, DE, FR, EU-wide"></div>
        </div>
      </div>
    </div>

    <!-- TAB 1: LABELING -->
    <div class="tab-panel" id="tab1">
      <div class="card">
        <div class="card-head"><span class="icon">2</span> Label & Operator Information</div>
        <div class="fg">
          <div class="field"><label>Operator Name (on label)</label><input id="f_op_name" placeholder="FBO name as printed on label"></div>
          <div class="field"><label>Operator Address</label><input id="f_op_addr" placeholder="Full address on label"></div>
          <div class="field"><label>Country of Origin</label><input id="f_origin" placeholder="e.g. Netherlands"></div>
          <div class="field"><label>Place of Provenance</label><input id="f_provenance" placeholder="If different from origin"></div>
          <div class="field"><label>Lot Identification</label><input id="f_lot" placeholder="e.g. L2025-0312"></div>
          <div class="field"><label>Date Marking</label>
            <select id="f_date_type">
              <option value="bbd">Best before date provided</option>
              <option value="use_by">Use by date provided</option>
              <option value="exempt">Exempt (>10% ABV, salt, vinegar, etc.)</option>
              <option value="none">Not provided</option>
            </select>
          </div>
          <div class="field"><label>Storage Conditions</label><input id="f_storage" placeholder="e.g. Keep refrigerated below 5°C"></div>
          <div class="field"><label>Instructions for Use</label><input id="f_instructions" placeholder="e.g. Heat for 3 minutes at 800W"></div>
          <div class="field"><label>Language(s) on Label</label><input id="f_lang" placeholder="e.g. Dutch, English, German"></div>
          <div class="field"><label>Largest Surface Area (cm²)</label><input id="f_surface" type="number" placeholder="For font size check. e.g. 120"></div>
        </div>
      </div>
    </div>

    <!-- TAB 2: INGREDIENTS & ALLERGENS -->
    <div class="tab-panel" id="tab2">
      <div class="card">
        <div class="card-head"><span class="icon">3</span> Ingredient List</div>
        <div class="fg">
          <div class="field full">
            <label>Ingredients (comma-separated, descending weight order)</label>
            <textarea id="f_ingredients" rows="4" placeholder="e.g. Water, Tomatoes (35%), Cream (MILK), Onion, Olive oil, Salt, Sugar, Garlic, Basil, Black pepper, Citric acid (E330)"></textarea>
            <div class="hint">List all ingredients including additives with E-numbers, compound ingredients, and processing aids where required. Allergens should appear here for the scan to detect them.</div>
          </div>
          <div class="field full">
            <label>QUID Required?</label>
            <select id="f_quid">
              <option value="yes">Yes - key ingredient % declared on label</option>
              <option value="no">No - not applicable</option>
              <option value="unsure">Unsure</option>
            </select>
            <div class="hint">QUID (Quantitative Ingredient Declaration) required when ingredient appears in the name, is highlighted, or is essential to characterise the food (Art. 22).</div>
          </div>
        </div>
      </div>
      <div class="card">
        <div class="card-head"><span class="icon">!</span> Allergen Declaration - Annex II (14 Regulated Allergens)</div>
        <p style="font-size:13px;color:var(--text-2);margin-bottom:14px">Tick allergens that are <strong>declared on your label</strong>. The tool will also scan your ingredient list for potential undeclared allergens.</p>
        <div class="allergen-grid" id="allergenGrid"></div>
      </div>
    </div>

    <!-- TAB 3: NUTRITION -->
    <div class="tab-panel" id="tab3">
      <div class="card">
        <div class="card-head"><span class="icon">4</span> Nutrition Declaration (per 100g or 100ml)</div>
        <p style="font-size:13px;color:var(--text-2);margin-bottom:14px">Mandatory for most prepacked foods (Art. 29-35). Leave blank if exempt.</p>
        <div class="fg">
          <div class="field"><label>Nutrition declaration provided?</label>
            <select id="f_nutri_provided">
              <option value="yes">Yes</option>
              <option value="exempt">Exempt</option>
              <option value="no">No - not provided</option>
            </select>
          </div>
          <div class="field"><label>Expressed per</label>
            <select id="f_nutri_per">
              <option value="100g">per 100g</option>
              <option value="100ml">per 100ml</option>
              <option value="portion">per portion (also per 100g/ml?)</option>
            </select>
          </div>
        </div>
        <div class="nutri-grid" style="margin-top:14px">
          <div class="field"><label>Energy (kJ)</label><input id="f_n_kj" type="number" step="0.1" placeholder="kJ"></div>
          <div class="field"><label>Energy (kcal)</label><input id="f_n_kcal" type="number" step="0.1" placeholder="kcal"></div>
          <div class="field"><label>Fat (g)</label><input id="f_n_fat" type="number" step="0.1" placeholder="g"></div>
          <div class="field"><label>of which Saturates (g)</label><input id="f_n_sat" type="number" step="0.1" placeholder="g"></div>
          <div class="field"><label>Carbohydrate (g)</label><input id="f_n_carb" type="number" step="0.1" placeholder="g"></div>
          <div class="field"><label>of which Sugars (g)</label><input id="f_n_sugar" type="number" step="0.1" placeholder="g"></div>
          <div class="field"><label>Protein (g)</label><input id="f_n_prot" type="number" step="0.1" placeholder="g"></div>
          <div class="field"><label>Salt (g)</label><input id="f_n_salt" type="number" step="0.1" placeholder="g"></div>
        </div>
        <div class="hint" style="margin-top:8px">The Big 7: Energy, fat, saturates, carbohydrate, sugars, protein, salt - all mandatory fields (Art. 30).</div>

        <details style="margin-top:16px;cursor:pointer">
          <summary style="font-size:13px;font-weight:600;color:var(--accent);padding:8px 0;user-select:none">+ Optional: Fibre, Vitamins & Minerals (for claim verification & Nutri-Score)</summary>
          <div class="nutri-grid" style="margin-top:10px">
            <div class="field"><label>Fibre (g)</label><input id="f_n_fibre" type="number" step="0.1" placeholder="g"></div>
            <div class="field"><label>Fruit/Veg/Nuts/Legumes (%)</label><input id="f_n_fvn" type="number" step="1" placeholder="%" min="0" max="100"></div>
          </div>
          <div class="nutri-grid" style="margin-top:8px">
            <div class="field"><label>Vitamin D (µg)</label><input id="f_n_vitD" type="number" step="0.01" placeholder="µg"></div>
            <div class="field"><label>Vitamin C (mg)</label><input id="f_n_vitC" type="number" step="0.1" placeholder="mg"></div>
            <div class="field"><label>Calcium (mg)</label><input id="f_n_calcium" type="number" step="0.1" placeholder="mg"></div>
            <div class="field"><label>Iron (mg)</label><input id="f_n_iron" type="number" step="0.1" placeholder="mg"></div>
          </div>
          <div class="nutri-grid" style="margin-top:8px">
            <div class="field"><label>Vitamin B12 (µg)</label><input id="f_n_vitB12" type="number" step="0.01" placeholder="µg"></div>
            <div class="field"><label>Folic Acid (µg)</label><input id="f_n_folate" type="number" step="1" placeholder="µg"></div>
            <div class="field"><label>Zinc (mg)</label><input id="f_n_zinc" type="number" step="0.1" placeholder="mg"></div>
            <div class="field"><label>Potassium (mg)</label><input id="f_n_potassium" type="number" step="1" placeholder="mg"></div>
          </div>
          <div class="hint" style="margin-top:8px">Reference Intake values from Annex XIII, Reg. 1169/2011. Used for "source of" (≥15% RI) and "high in" (≥30% RI) claim verification. Fibre + fruit/veg % enable Nutri-Score estimation.</div>
        </details>
      </div>
    </div>

    <!-- TAB 4: CLAIMS & OTHER -->
    <div class="tab-panel" id="tab4">
      <div class="card">
        <div class="card-head"><span class="icon">5</span> Claims, GI & Additional Information</div>
        <div class="fg">
          <div class="field full">
            <label>Nutrition / Health / Marketing Claims</label>
            <textarea id="f_claims" rows="3" placeholder="e.g. High in fibre, Source of calcium, Handcrafted, No artificial colours, Supports immune function"></textarea>
            <div class="hint">Include ALL claims appearing on label/packaging, including front-of-pack.</div>
          </div>
          <div class="field">
            <label>Geographic Indication?</label>
            <select id="f_gi"><option value="no">No</option><option value="pdo">PDO (Protected Designation of Origin)</option><option value="pgi">PGI (Protected Geographical Indication)</option><option value="tsg">TSG (Traditional Speciality Guaranteed)</option></select>
          </div>
          <div class="field"><label>GI Name</label><input id="f_gi_name" placeholder="e.g. Parmigiano Reggiano, Gouda Holland"></div>
          <div class="field">
            <label>Organic Certification?</label>
            <select id="f_organic"><option value="no">No</option><option value="yes">Yes - EU organic logo present</option></select>
          </div>
          <div class="field">
            <label>Novel Food?</label>
            <select id="f_novel"><option value="no">No</option><option value="yes">Yes - contains novel food ingredient(s)</option><option value="unsure">Unsure</option></select>
          </div>
          <div class="field">
            <label>GMO Declaration</label>
            <select id="f_gmo"><option value="no">No GMO ingredients</option><option value="yes">Contains/produced from GMOs</option><option value="free">Labelled as GMO-free</option></select>
          </div>
          <div class="field full">
            <label>Additional Notes</label>
            <textarea id="f_notes" rows="2" placeholder="Any other label features, warnings, or concerns..."></textarea>
          </div>
        </div>
      </div>
    </div>

    <!-- TAB 5: LEGAL BASIS -->
    <div class="tab-panel" id="tab5">
      <div class="card">
        <div class="card-head"><span class="icon">§</span> Regulatory Framework</div>
        <p style="font-size:13px;color:var(--text-2);margin-bottom:16px">This tool screens product labels against the following EU legislation. All texts are freely accessible via EUR-Lex, the official portal for European Union law.</p>
        <div style="display:flex;flex-direction:column;gap:10px">

          <div style="padding:14px 18px;background:var(--bg);border-radius:var(--r);border:1px solid var(--border-light);border-left:3px solid var(--accent)">
            <div style="display:flex;justify-content:space-between;align-items:start;gap:12px;flex-wrap:wrap">
              <div>
                <div style="font-size:14px;font-weight:600;color:var(--brand)">Regulation (EU) No 1169/2011</div>
                <div style="font-size:13px;color:var(--text-2);margin-top:2px">Food Information to Consumers (FIC)</div>
                <div style="font-size:12px;color:var(--text-3);margin-top:4px">Primary legal basis for this tool. Governs mandatory labelling for all food placed on the EU market.</div>
                <div style="font-size:12px;font-family:var(--mono);color:var(--text-3);margin-top:6px">Articles referenced: 7 (fair practices), 8 (FBO responsibility), 9 (mandatory particulars), 13 (font size), 15 (language), 16 (exemptions), 17 (naming), 18–20 (ingredients), 21 (allergens, Annex II), 22 (QUID), 23 (net quantity), 24 (date marking, Annex X), 26 (origin), 28 (ABV, Annex XII), 29–35 (nutrition declaration)</div>
              </div>
              <a href="https://eur-lex.europa.eu/eli/reg/2011/1169/oj/eng" target="_blank" rel="noopener" class="btn btn-ghost" style="font-size:12px;padding:6px 14px;white-space:nowrap">View on EUR-Lex</a>
            </div>
          </div>

          <div style="padding:14px 18px;background:var(--bg);border-radius:var(--r);border:1px solid var(--border-light);border-left:3px solid var(--accent)">
            <div style="display:flex;justify-content:space-between;align-items:start;gap:12px;flex-wrap:wrap">
              <div>
                <div style="font-size:14px;font-weight:600;color:var(--brand)">Regulation (EC) No 1924/2006</div>
                <div style="font-size:13px;color:var(--text-2);margin-top:2px">Nutrition and Health Claims made on Foods</div>
                <div style="font-size:12px;color:var(--text-3);margin-top:4px">Governs conditions for nutrition claims (Annex), health claims (Art. 13–14), and prohibition of health claims on alcohol >1.2% ABV (Art. 4(3)).</div>
                <div style="font-size:12px;font-family:var(--mono);color:var(--text-3);margin-top:6px">Articles referenced: 4(3), 5, 8, 10, 13, 14, Annex</div>
              </div>
              <a href="https://eur-lex.europa.eu/eli/reg/2006/1924/oj/eng" target="_blank" rel="noopener" class="btn btn-ghost" style="font-size:12px;padding:6px 14px;white-space:nowrap">View on EUR-Lex</a>
            </div>
          </div>

          <div style="padding:14px 18px;background:var(--bg);border-radius:var(--r);border:1px solid var(--border-light);border-left:3px solid var(--accent)">
            <div style="display:flex;justify-content:space-between;align-items:start;gap:12px;flex-wrap:wrap">
              <div>
                <div style="font-size:14px;font-weight:600;color:var(--brand)">Regulation (EU) 2019/787</div>
                <div style="font-size:13px;color:var(--text-2);margin-top:2px">Spirit Drinks - definition, description, presentation, labelling, GI protection</div>
                <div style="font-size:12px;color:var(--text-3);margin-top:4px">Defines spirit drink categories with minimum ABV thresholds and compositional rules. Protects geographical indications for spirits.</div>
                <div style="font-size:12px;font-family:var(--mono);color:var(--text-3);margin-top:6px">Articles referenced: Annex I (categories), Art. 34–42 (GI)</div>
              </div>
              <a href="https://eur-lex.europa.eu/eli/reg/2019/787/oj/eng" target="_blank" rel="noopener" class="btn btn-ghost" style="font-size:12px;padding:6px 14px;white-space:nowrap">View on EUR-Lex</a>
            </div>
          </div>

          <div style="padding:14px 18px;background:var(--bg);border-radius:var(--r);border:1px solid var(--border-light);border-left:3px solid var(--accent)">
            <div style="display:flex;justify-content:space-between;align-items:start;gap:12px;flex-wrap:wrap">
              <div>
                <div style="font-size:14px;font-weight:600;color:var(--brand)">Directive 2011/91/EU</div>
                <div style="font-size:13px;color:var(--text-2);margin-top:2px">Lot Identification of Foodstuffs</div>
                <div style="font-size:12px;color:var(--text-3);margin-top:4px">Requires indications for identifying the lot to which a foodstuff belongs, enabling traceability and targeted recall.</div>
              </div>
              <a href="https://eur-lex.europa.eu/eli/dir/2011/91/oj/eng" target="_blank" rel="noopener" class="btn btn-ghost" style="font-size:12px;padding:6px 14px;white-space:nowrap">View on EUR-Lex</a>
            </div>
          </div>

          <div style="padding:14px 18px;background:var(--bg);border-radius:var(--r);border:1px solid var(--border-light);border-left:3px solid var(--accent)">
            <div style="display:flex;justify-content:space-between;align-items:start;gap:12px;flex-wrap:wrap">
              <div>
                <div style="font-size:14px;font-weight:600;color:var(--brand)">Regulation (EU) No 1151/2012</div>
                <div style="font-size:13px;color:var(--text-2);margin-top:2px">Quality Schemes for Agricultural Products and Foodstuffs</div>
                <div style="font-size:12px;color:var(--text-3);margin-top:4px">Establishes PDO, PGI, and TSG protection schemes. GI claims must be verified against eAmbrosia/GIView database.</div>
              </div>
              <a href="https://eur-lex.europa.eu/eli/reg/2012/1151/oj/eng" target="_blank" rel="noopener" class="btn btn-ghost" style="font-size:12px;padding:6px 14px;white-space:nowrap">View on EUR-Lex</a>
            </div>
          </div>

          <div style="padding:14px 18px;background:var(--bg);border-radius:var(--r);border:1px solid var(--border-light);border-left:3px solid var(--accent)">
            <div style="display:flex;justify-content:space-between;align-items:start;gap:12px;flex-wrap:wrap">
              <div>
                <div style="font-size:14px;font-weight:600;color:var(--brand)">Regulation (EU) 2015/2283</div>
                <div style="font-size:13px;color:var(--text-2);margin-top:2px">Novel Foods</div>
                <div style="font-size:12px;color:var(--text-3);margin-top:4px">Requires pre-market authorisation for foods without significant consumption history in the EU before May 1997.</div>
              </div>
              <a href="https://eur-lex.europa.eu/eli/reg/2015/2283/oj/eng" target="_blank" rel="noopener" class="btn btn-ghost" style="font-size:12px;padding:6px 14px;white-space:nowrap">View on EUR-Lex</a>
            </div>
          </div>

          <div style="padding:14px 18px;background:var(--bg);border-radius:var(--r);border:1px solid var(--border-light);border-left:3px solid var(--accent)">
            <div style="display:flex;justify-content:space-between;align-items:start;gap:12px;flex-wrap:wrap">
              <div>
                <div style="font-size:14px;font-weight:600;color:var(--brand)">Regulation (EU) 2018/848 &middot; Regulation (EU) 2018/775</div>
                <div style="font-size:13px;color:var(--text-2);margin-top:2px">Organic Production / Primary Ingredient Origin</div>
                <div style="font-size:12px;color:var(--text-3);margin-top:4px">2018/848: EU organic logo, certifying body code, origin. 2018/775: implementing rules for indicating primary ingredient origin under Art. 26(3) of 1169/2011.</div>
              </div>
              <a href="https://eur-lex.europa.eu/eli/reg/2018/848/oj/eng" target="_blank" rel="noopener" class="btn btn-ghost" style="font-size:12px;padding:6px 14px;white-space:nowrap">View on EUR-Lex</a>
            </div>
          </div>

          <div style="padding:14px 18px;background:var(--bg);border-radius:var(--r);border:1px solid var(--border-light);border-left:3px solid var(--accent)">
            <div style="display:flex;justify-content:space-between;align-items:start;gap:12px;flex-wrap:wrap">
              <div>
                <div style="font-size:14px;font-weight:600;color:var(--brand)">Regulation (EC) 1829/2003 &middot; Regulation (EC) 1830/2003</div>
                <div style="font-size:13px;color:var(--text-2);margin-top:2px">GMO Food/Feed &amp; Traceability</div>
                <div style="font-size:12px;color:var(--text-3);margin-top:4px">Labelling required when GMO content exceeds 0.9% threshold per ingredient. Traceability documentation obligations.</div>
              </div>
              <a href="https://eur-lex.europa.eu/eli/reg/2003/1829/oj/eng" target="_blank" rel="noopener" class="btn btn-ghost" style="font-size:12px;padding:6px 14px;white-space:nowrap">View on EUR-Lex</a>
            </div>
          </div>

          <div style="padding:14px 18px;background:var(--bg);border-radius:var(--r);border:1px solid var(--border-light);border-left:3px solid var(--accent)">
            <div style="display:flex;justify-content:space-between;align-items:start;gap:12px;flex-wrap:wrap">
              <div>
                <div style="font-size:14px;font-weight:600;color:var(--brand)">Directive 2005/29/EC</div>
                <div style="font-size:13px;color:var(--text-2);margin-top:2px">Unfair Commercial Practices</div>
                <div style="font-size:12px;color:var(--text-3);margin-top:4px">General framework for assessing misleading marketing claims (e.g. "handcrafted", "traditional") that fall outside 1924/2006 scope.</div>
              </div>
              <a href="https://eur-lex.europa.eu/eli/dir/2005/29/oj/eng" target="_blank" rel="noopener" class="btn btn-ghost" style="font-size:12px;padding:6px 14px;white-space:nowrap">View on EUR-Lex</a>
            </div>
          </div>

          <!-- Dir. 2002/46/EC -->
          <div style="padding:14px 18px;background:var(--bg);border-radius:var(--r);border:1px solid var(--border-light);border-left:3px solid var(--accent)">
            <div style="display:flex;justify-content:space-between;align-items:start;gap:12px;flex-wrap:wrap">
              <div>
                <div style="font-size:14px;font-weight:600;color:var(--brand)">Directive 2002/46/EC</div>
                <div style="font-size:13px;color:var(--text-2);margin-top:2px">Food Supplements</div>
                <div style="font-size:12px;color:var(--text-3);margin-top:4px">Specific labelling requirements for food supplements: designation, recommended daily dose, warnings, and vitamin/mineral declarations. Applies in addition to Reg. 1169/2011.</div>
                <div style="font-size:12px;font-family:var(--mono);color:var(--text-3);margin-top:6px">Articles referenced: 6(1)–(3) (mandatory information), Annex I–II (permitted forms)</div>
              </div>
              <a href="https://eur-lex.europa.eu/eli/dir/2002/46/oj/eng" target="_blank" rel="noopener" class="btn btn-ghost" style="font-size:12px;padding:6px 14px;white-space:nowrap">View on EUR-Lex</a>
            </div>
          </div>

          <!-- Reg. 1308/2013 (CMO) as amended by Reg. 2021/2117 -->
          <div style="padding:14px 18px;background:var(--bg);border-radius:var(--r);border:1px solid var(--border-light);border-left:3px solid var(--accent)">
            <div style="display:flex;justify-content:space-between;align-items:start;gap:12px;flex-wrap:wrap">
              <div>
                <div style="font-size:14px;font-weight:600;color:var(--brand)">Regulation (EU) No 1308/2013 as amended by Reg. 2021/2117</div>
                <div style="font-size:13px;color:var(--text-2);margin-top:2px">Common Market Organisation (Wine labelling)</div>
                <div style="font-size:12px;color:var(--text-3);margin-top:4px">Since 8 December 2023, wine and aromatised wine products must include ingredient listing and nutrition declaration (at minimum energy value on-label). E-label (QR code) permitted for full details.</div>
                <div style="font-size:12px;font-family:var(--mono);color:var(--text-3);margin-top:6px">Articles referenced: Art. 119(1) (labelling requirements), Commission Delegated Reg. 2023/1606 (implementing rules)</div>
              </div>
              <a href="https://eur-lex.europa.eu/eli/reg/2013/1308/oj/eng" target="_blank" rel="noopener" class="btn btn-ghost" style="font-size:12px;padding:6px 14px;white-space:nowrap">View on EUR-Lex</a>
            </div>
          </div>

        </div>
        <p style="font-size:12px;color:var(--text-3);margin-top:16px;padding-top:12px;border-top:1px solid var(--border-light)">All links point to the official EU law portal (EUR-Lex). Consolidated versions are shown where available. National implementing measures may impose additional requirements in individual Member States. This tool was last updated against legislation in force as of February 2026.</p>
      </div>
    </div>

    <div class="btn-row" style="flex-direction:column;gap:12px">
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn btn-primary" onclick="runCheck()">Run Screening</button>
        <button class="btn btn-ghost" onclick="clearAll()">Clear All</button>
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
        <span style="font-size:11px;color:var(--text-3);font-weight:600;text-transform:uppercase;letter-spacing:0.5px">Try an example:</span>
        <button class="btn btn-ghost" style="font-size:12px;padding:6px 14px" onclick="loadExample('soup')">Tomato Soup</button>
        <button class="btn btn-ghost" style="font-size:12px;padding:6px 14px" onclick="loadExample('cheese')">Gouda Cheese</button>
        <button class="btn btn-ghost" style="font-size:12px;padding:6px 14px" onclick="loadExample('gin')">Craft Gin</button>
        <button class="btn btn-ghost" style="font-size:12px;padding:6px 14px" onclick="loadExample('supplement')">Vitamin D</button>
      </div>
    </div>
  </div>

  <!-- ── RESULTS ── -->
  <div id="resultsPanel">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;margin-top:32px">
      <h2 style="font-family:var(--serif);font-size:28px;font-weight:400;color:var(--brand)">Regulatory Situation Analysis</h2>
      <span id="rptId" style="font-family:var(--mono);font-size:11px;color:var(--text-3)"></span>
    </div>
    <div class="summary-grid" id="summaryGrid"></div>
    <div id="verdictBar"></div>
    <div class="checks" id="checksList"></div>
    <div class="btn-row" style="margin-top:20px">
      <button class="btn btn-primary" onclick="generatePDF()">Download Report (PDF)</button>
      <button class="btn btn-ghost" onclick="exportJSON()">Export JSON</button>
      <button class="btn btn-ghost" onclick="window.print()">Print page</button>
    </div>
    <div class="disclaimer">
      <strong>Disclaimer:</strong> This tool provides regulatory pre-screening based on user-entered data. It separates what is mechanically decidable from what requires expert judgement or external evidence. It does not constitute legal advice or a compliance determination. Final regulatory responsibility rests with the food business operator under Article 8 of <a href="https://eur-lex.europa.eu/eli/reg/2011/1169/oj/eng" target="_blank" rel="noopener" style="color:var(--accent)">Regulation (EU) No 1169/2011</a>. For complex formulations, novel foods, or cross-border regulatory questions, independent legal review is recommended.<br><br>
      <strong>Tool:</strong> EU LABEL CHECK &mdash; &copy; 2026 <a href="https://www.linkedin.com/in/daniil-smetanca" target="_blank" rel="noopener" style="color:var(--accent);text-decoration:none">Daniil Smetanca</a>, MSc Student Food Safety, Wageningen University &amp; Research &mdash; <a href="#" onclick="switchTab(5);document.querySelector('.tab-bar').scrollIntoView({behavior:'smooth'});return false" style="color:var(--accent)">View full legal basis</a>
    </div>
  </div>
</div>

<div class="footer">
  <div style="margin-bottom:8px"><strong style="color:var(--text-2)">EU LABEL CHECK</strong> - EU Food Label Regulatory Screening Tool</div>
  <div style="margin-top:6px">&copy; 2026 <a href="https://www.linkedin.com/in/daniil-smetanca" target="_blank" rel="noopener" style="color:var(--accent);text-decoration:none">Daniil Smetanca</a> &middot; MSc Student Food Safety, <a href="https://www.wur.nl" target="_blank" rel="noopener" style="color:var(--accent);text-decoration:none">Wageningen University &amp; Research</a></div>
  <div style="margin-top:6px;font-size:10px;color:var(--text-3)">This tool provides regulatory pre-screening only. It separates mechanically decidable findings from those requiring expert judgement. Final regulatory responsibility rests with the food business operator (Art. 8, Reg. 1169/2011). Not a substitute for legal advice. All regulatory references verified against EUR-Lex consolidated texts (Feb 2026).</div>
</div>

<script>
// ══════════════════════════════════════════════════════════════════
// REFERENCE DATA
// ══════════════════════════════════════════════════════════════════

const ALLERGENS = {
  gluten:      { n:"Cereals containing gluten", ref:"1", kw:["wheat","rye","barley","oats","spelt","kamut","gluten","flour","malt","semolina","couscous","bulgur","seitan","breadcrumbs","bran","wheat starch","barley malt","malt extract","malt vinegar","triticale","einkorn","emmer","durum"] },
  crustaceans: { n:"Crustaceans", ref:"2", kw:["crab","lobster","shrimp","prawn","crayfish","langoustine","scampi","krill","crustacean"] },
  eggs:        { n:"Eggs", ref:"3", kw:["egg","albumin","lysozyme","mayonnaise","ovalbumin","meringue","egg lecithin","ovomucin"] },
  fish:        { n:"Fish", ref:"4", kw:["fish","anchovy","cod","salmon","tuna","isinglass","sardine","herring","mackerel","trout","bass","haddock","fish sauce","fish oil","surimi","caviar","roe","worcestershire"] },
  peanuts:     { n:"Peanuts", ref:"5", kw:["peanut","groundnut","arachis","monkey nut","peanut oil","peanut butter","peanut flour"] },
  soybeans:    { n:"Soybeans", ref:"6", kw:["soy","soya","tofu","tempeh","miso","edamame","soy sauce","soy protein","soy lecithin","soybean oil","textured vegetable protein"] },
  milk:        { n:"Milk / Lactose", ref:"7", kw:["milk","lactose","casein","caseinate","whey","cream","butter","cheese","yogurt","yoghurt","ghee","lactalbumin","buttermilk","milk powder","condensed milk","milk protein","curds","skimmed milk","whole milk","semi-skimmed"] },
  tree_nuts:   { n:"Tree Nuts", ref:"8", kw:["almond","hazelnut","walnut","cashew","pecan","brazil nut","pistachio","macadamia","praline","marzipan","nougat","frangipane","gianduja","chestnut"] },
  celery:      { n:"Celery", ref:"9", kw:["celery","celeriac","celery salt","celery seed","celery powder"] },
  mustard:     { n:"Mustard", ref:"10", kw:["mustard","mustard seed","mustard oil","dijon","mustard flour","mustard powder"] },
  sesame:      { n:"Sesame", ref:"11", kw:["sesame","tahini","tahina","sesame oil","sesame paste","halvah","halva"] },
  sulphites:   { n:"Sulphites (>10mg/kg SO₂)", ref:"12", kw:["sulphite","sulfite","sulphur dioxide","sulfur dioxide","so2","e220","e221","e222","e223","e224","e225","e226","e227","e228","metabisulphite","metabisulfite","bisulphite","bisulfite"] },
  lupin:       { n:"Lupin", ref:"13", kw:["lupin","lupine","lupini","lupin flour","lupin protein"] },
  molluscs:    { n:"Molluscs", ref:"14", kw:["mussel","oyster","clam","scallop","squid","octopus","snail","escargot","abalone","cuttlefish","calamari","mollusc","mollusk","whelk","cockle"] }
};

const SPIRIT_MIN_ABV = { vodka:37.5, gin:37.5, whisky:40, whiskey:40, rum:37.5, brandy:36, liqueur:15, tequila:37.5 };

// Reference Intake values - Annex XIII, Reg. 1169/2011
const RI = {
  vitD: { name:"Vitamin D", unit:"µg", ri:5 },
  vitC: { name:"Vitamin C", unit:"mg", ri:80 },
  calcium: { name:"Calcium", unit:"mg", ri:800 },
  iron: { name:"Iron", unit:"mg", ri:14 },
  vitB12: { name:"Vitamin B12", unit:"µg", ri:2.5 },
  folate: { name:"Folic acid", unit:"µg", ri:200 },
  zinc: { name:"Zinc", unit:"mg", ri:10 },
  potassium: { name:"Potassium", unit:"mg", ri:2000 },
};

// Nutri-Score 2023 algorithm (beverages + solid food)
function calcNutriScore(d, isLiquid, isBev) {
  if (d.nKcal === null || d.nSugar === null || d.nSat === null || d.nSalt === null) return null;
  if (d.nProt === null) return null;
  const fibre = d.nFibre !== null ? d.nFibre : 0;
  const fvn = d.nFVN !== null ? d.nFVN : 0;

  if (isBev) {
    // 2023 beverage scoring
    let negE=0, negSu=0, negSat=0, negSa=0;
    // Energy points (kJ) - beverage thresholds
    const ekj = d.nKj !== null ? d.nKj : d.nKcal * 4.184;
    if (ekj>0) negE=1; if (ekj>30) negE=2; if (ekj>60) negE=3; if (ekj>90) negE=4;
    if (ekj>120) negE=5; if (ekj>150) negE=6; if (ekj>180) negE=7; if (ekj>210) negE=8;
    if (ekj>240) negE=9; if (ekj>270) negE=10;
    // Sugars - beverage
    const su = d.nSugar;
    if (su>0) negSu=1; if (su>1.5) negSu=2; if (su>3) negSu=3; if (su>4.5) negSu=4;
    if (su>6) negSu=5; if (su>7.5) negSu=6; if (su>9) negSu=7; if (su>10.5) negSu=8;
    if (su>12) negSu=9; if (su>13.5) negSu=10;
    // Sat - same as food
    const sat = d.nSat;
    if (sat>1) negSat=1; if (sat>2) negSat=2; if (sat>3) negSat=3; if (sat>4) negSat=4;
    if (sat>5) negSat=5; if (sat>6) negSat=6; if (sat>7) negSat=7; if (sat>8) negSat=8;
    if (sat>9) negSat=9; if (sat>10) negSat=10;
    // Salt - same as food
    const sa = d.nSalt;
    if (sa>0.2) negSa=1; if (sa>0.4) negSa=2; if (sa>0.6) negSa=3; if (sa>0.8) negSa=4;
    if (sa>1) negSa=5; if (sa>1.2) negSa=6; if (sa>1.4) negSa=7; if (sa>1.6) negSa=8;
    if (sa>1.8) negSa=9; if (sa>2) negSa=10;
    const neg = negE + negSu + negSat + negSa;

    // Positive - fruit/veg only for beverages
    let posFVN = 0;
    if (fvn>40) posFVN=2; if (fvn>60) posFVN=4; if (fvn>80) posFVN=10;

    const score = neg - posFVN;
    // Water is always A
    if (d.nKcal === 0 && d.nSugar === 0) return { score: -15, grade:"A", color:"#038141" };
    let grade, color;
    if (score <= 2) { grade="B"; color="#85BB2F"; }
    else if (score <= 6) { grade="C"; color="#FECB02"; }
    else if (score <= 9) { grade="D"; color="#EE8100"; }
    else { grade="E"; color="#E63E11"; }
    if (score <= -1) { grade="A"; color="#038141"; }
    return { score, grade, color };
  }

  // 2023 solid food scoring
  let negE=0, negSu=0, negSat=0, negSa=0;
  const ekj = d.nKj !== null ? d.nKj : d.nKcal * 4.184;
  if (ekj>335) negE=1; if (ekj>670) negE=2; if (ekj>1005) negE=3; if (ekj>1340) negE=4;
  if (ekj>1675) negE=5; if (ekj>2010) negE=6; if (ekj>2345) negE=7; if (ekj>2680) negE=8;
  if (ekj>3015) negE=9; if (ekj>3350) negE=10;

  const su = d.nSugar;
  if (su>3.4) negSu=1; if (su>6.8) negSu=2; if (su>10) negSu=3; if (su>14) negSu=4;
  if (su>17) negSu=5; if (su>20) negSu=6; if (su>24) negSu=7; if (su>27) negSu=8;
  if (su>31) negSu=9; if (su>34) negSu=10;

  const sat = d.nSat;
  if (sat>1) negSat=1; if (sat>2) negSat=2; if (sat>3) negSat=3; if (sat>4) negSat=4;
  if (sat>5) negSat=5; if (sat>6) negSat=6; if (sat>7) negSat=7; if (sat>8) negSat=8;
  if (sat>9) negSat=9; if (sat>10) negSat=10;

  const sa = d.nSalt;
  if (sa>0.2) negSa=1; if (sa>0.4) negSa=2; if (sa>0.6) negSa=3; if (sa>0.8) negSa=4;
  if (sa>1) negSa=5; if (sa>1.2) negSa=6; if (sa>1.4) negSa=7; if (sa>1.6) negSa=8;
  if (sa>1.8) negSa=9; if (sa>2) negSa=10;

  const neg = negE + negSu + negSat + negSa;

  // Positive points
  let posFVN=0, posFib=0, posProt=0;
  if (fvn>40) posFVN=1; if (fvn>60) posFVN=2; if (fvn>80) posFVN=5;
  if (fibre>3.0) posFib=1; if (fibre>4.1) posFib=2; if (fibre>5.2) posFib=3; if (fibre>6.3) posFib=4; if (fibre>7.4) posFib=5;
  if (d.nProt>2.4) posProt=1; if (d.nProt>4.8) posProt=2; if (d.nProt>7.2) posProt=3; if (d.nProt>9.6) posProt=4; if (d.nProt>12) posProt=5;

  // If neg >= 11 and fvn < 80, protein does not count
  let pos = posFVN + posFib;
  if (neg < 11 || fvn >= 80) pos += posProt;

  const score = neg - pos;
  let grade, color;
  if (score <= -1) { grade="A"; color="#038141"; }
  else if (score <= 2) { grade="B"; color="#85BB2F"; }
  else if (score <= 10) { grade="C"; color="#FECB02"; }
  else if (score <= 18) { grade="D"; color="#EE8100"; }
  else { grade="E"; color="#E63E11"; }
  return { score, grade, color };
}

const EURLEX = {
  "1169/2011": "https://eur-lex.europa.eu/eli/reg/2011/1169/oj/eng",
  "1924/2006": "https://eur-lex.europa.eu/eli/reg/2006/1924/oj/eng",
  "2019/787": "https://eur-lex.europa.eu/eli/reg/2019/787/oj/eng",
  "2011/91": "https://eur-lex.europa.eu/eli/dir/2011/91/oj/eng",
  "1151/2012": "https://eur-lex.europa.eu/eli/reg/2012/1151/oj/eng",
  "2015/2283": "https://eur-lex.europa.eu/eli/reg/2015/2283/oj/eng",
  "2018/848": "https://eur-lex.europa.eu/eli/reg/2018/848/oj/eng",
  "2018/775": "https://eur-lex.europa.eu/eli/reg_impl/2018/775/oj/eng",
  "1829/2003": "https://eur-lex.europa.eu/eli/reg/2003/1829/oj/eng",
  "1830/2003": "https://eur-lex.europa.eu/eli/reg/2003/1830/oj/eng",
  "2005/29": "https://eur-lex.europa.eu/eli/dir/2005/29/oj/eng",
  "1308/2013": "https://eur-lex.europa.eu/eli/reg/2013/1308/oj/eng",
  "2002/46": "https://eur-lex.europa.eu/eli/dir/2002/46/oj/eng",
  "178/2002": "https://eur-lex.europa.eu/eli/reg/2002/178/oj/eng",
  "2017/2470": "https://eur-lex.europa.eu/eli/reg_impl/2017/2470/oj/eng",
};

function linkifyRef(ref) {
  if (!ref) return "";
  let out = ref;
  for (const [num, url] of Object.entries(EURLEX)) {
    const escaped = num.replace("/", "\\/");
    const regex = new RegExp("(Reg\\.?|Regulation|Dir\\.?|Directive)[^0-9]*" + escaped.replace(/\//g,"\\/"), "g");
    if (ref.includes(num)) {
      out = out.replace(new RegExp(num.replace("/","\\/"), "g"), `<a href="${url}" target="_blank" rel="noopener" style="color:var(--accent);text-decoration:underline">${num}</a>`);
    }
  }
  return out;
}

const NUTRITION_EXEMPT = ["Spirit","Beer","Supplement"];
const DATE_EXEMPT_CATS = ["Spirit","Wine"];

// ══════════════════════════════════════════════════════════════════
// ALLERGEN UI
// ══════════════════════════════════════════════════════════════════
const ag = document.getElementById("allergenGrid");
for (const [k,v] of Object.entries(ALLERGENS)) {
  const d = document.createElement("label");
  d.className = "allergen-item";
  d.id = "ai_"+k;
  d.innerHTML = `<input type="checkbox" value="${k}"> ${v.ref}. ${v.n}`;
  ag.appendChild(d);
}

// ══════════════════════════════════════════════════════════════════
// TABS
// ══════════════════════════════════════════════════════════════════
function switchTab(i) {
  document.querySelectorAll('.tab').forEach((t,j) => t.classList.toggle('active', j===i));
  document.querySelectorAll('.tab-panel').forEach((p,j) => p.classList.toggle('active', j===i));
}

// ══════════════════════════════════════════════════════════════════
// GATHER DATA
// ══════════════════════════════════════════════════════════════════
function gatherData() {
  const v = id => document.getElementById(id)?.value?.trim() || "";
  const n = id => { const x = parseFloat(v(id)); return isNaN(x) ? null : x; };
  return {
    name: v("f_name"), company: v("f_company"), category: v("f_cat"), subcategory: v("f_subcat"),
    qty: v("f_qty"), pkg: v("f_pkg"), abv: n("f_abv"), markets: v("f_markets"),
    opName: v("f_op_name"), opAddr: v("f_op_addr"), origin: v("f_origin"), provenance: v("f_provenance"),
    lot: v("f_lot"), dateType: v("f_date_type"), storage: v("f_storage"), instructions: v("f_instructions"),
    lang: v("f_lang"), surface: n("f_surface"),
    ingredients: v("f_ingredients").split(",").map(s=>s.trim()).filter(Boolean),
    quid: v("f_quid"),
    declaredAllergens: new Set(Array.from(document.querySelectorAll('#allergenGrid input:checked')).map(c=>c.value)),
    nutriProvided: v("f_nutri_provided"), nutriPer: v("f_nutri_per"),
    nKj: n("f_n_kj"), nKcal: n("f_n_kcal"), nFat: n("f_n_fat"), nSat: n("f_n_sat"),
    nCarb: n("f_n_carb"), nSugar: n("f_n_sugar"), nProt: n("f_n_prot"), nSalt: n("f_n_salt"),
    nFibre: n("f_n_fibre"), nFVN: n("f_n_fvn"),
    nVitD: n("f_n_vitD"), nVitC: n("f_n_vitC"), nCalcium: n("f_n_calcium"), nIron: n("f_n_iron"),
    nVitB12: n("f_n_vitB12"), nFolate: n("f_n_folate"), nZinc: n("f_n_zinc"), nPotassium: n("f_n_potassium"),
    claims: v("f_claims").split(",").map(s=>s.trim()).filter(Boolean),
    gi: v("f_gi"), giName: v("f_gi_name"), organic: v("f_organic"),
    novel: v("f_novel"), gmo: v("f_gmo"), notes: v("f_notes"),
  };
}

// ══════════════════════════════════════════════════════════════════
// VALIDATION CHECKS
// ══════════════════════════════════════════════════════════════════

function scanAllergens(ingredients) {
  const txt = ingredients.join(" ").toLowerCase();
  const found = {};
  for (const [k,v] of Object.entries(ALLERGENS)) {
    const hits = v.kw.filter(w => txt.includes(w.toLowerCase()));
    if (hits.length) found[k] = { name: v.n, hits };
  }
  return found;
}

function chk(name, result, conf, reasoning, ref, rec, type) {
  // type: structural | trigger | evidence | interpretive
  return { name, result, conf, reasoning, ref: ref||"", rec: rec||"", type: type||"structural" };
}

function runChecks(d) {
  const checks = [];
  const isAlc = d.abv !== null && d.abv > 1.2;
  const catLow = (d.category||"").toLowerCase();
  const isLiquid = ["Beverage","Spirit","Wine","Beer","Juice"].includes(d.category) || catLow.includes("liquid") || catLow.includes("drink") || (d.qty||"").toLowerCase().match(/\b(ml|cl|l)\b/);
  const perUnit = isLiquid ? "100ml" : "100g";

  // 1. PRODUCT NAME
  checks.push(d.name
    ? chk("Product Name","PASS",0.9,`Product name declared: "${d.name}". Art. 17 establishes a naming hierarchy: first the legal name (if one exists in EU or national law), then a customary name, then a descriptive name. If the product has undergone treatment (e.g. smoked, frozen, reconstituted), this must appear alongside the name.`,"Art. 9(1)(a), Art. 17, Annex VI, Reg. 1169/2011","Check Annex VI for reserved designations (e.g. 'cream' requires minimum milkfat content, 'juice' implies 100% fruit content). If selling into multiple Member States, check national naming legislation - naming conventions differ across markets. If any physical condition or treatment (frozen, dried, smoked, powdered, irradiated, concentrated, defrosted) has been applied, include it next to the name. For irradiated ingredients, state 'irradiated' or 'treated with ionising radiation'.")
    : chk("Product Name","BLOCK",0.95,"No product name provided. This is a mandatory particular under Art. 9(1)(a).","Art. 9(1)(a), Art. 17, Reg. 1169/2011","Provide the legal name (if one is defined in EU or national legislation), the customary name (if commonly understood by the consumer in target markets), or a descriptive name (sufficiently precise to identify the food and distinguish it from other products). Include any physical treatment applied to the product.")
  );

  // 2. NET QUANTITY
  checks.push(d.qty
    ? chk("Net Quantity","PASS",0.85,`Net quantity: ${d.qty}. Must be expressed in litres/centilitres/millilitres for liquids or kilograms/grams for solids. For solid foods in a liquid medium, drain weight must also be declared.`,"Art. 9(1)(e), Art. 23, Annex IX, Reg. 1169/2011","Check the metric unit is correct for your product type. Minimum numeral height is set by Annex IX (e.g. ≥4mm for 200g–1kg). The quantity must appear in the same field of vision as the product name and be based on weight at time of packaging. For multi-packs (e.g. '6 × 100g'), state both the number of items and net quantity per unit.")
    : chk("Net Quantity","BLOCK",0.9,"No net quantity declared. Mandatory for all prepacked foods.","Art. 9(1)(e), Art. 23, Annex IX, Reg. 1169/2011","Declare net quantity using metric units: litres (l), centilitres (cl), or millilitres (ml) for liquids; kilograms (kg) or grams (g) for solids. Minimum numeral height depends on declared quantity (Annex IX). For solid foods in liquid medium, also state drained net weight.")
  );

  // 3. OPERATOR INFO
  const hasOp = d.opName || d.opAddr;
  checks.push(hasOp
    ? chk("FBO Identification","PASS",0.85,`Operator: ${d.opName}${d.opAddr ? ", "+d.opAddr : ""}. Under Art. 8, this must be the FBO under whose name or business name the food is marketed, or, if not established in the EU, the importer into the EU market.`,"Art. 9(1)(h), Art. 8, Reg. 1169/2011","The named entity is the actual responsible FBO - not a contract manufacturer, unless they market under their own name. For imported products, the EU-based importer must be named. Address should be the registered business address, not a P.O. box. If selling via Amazon/marketplace, the FBO is still the entity responsible for food information, not the platform.")
    : chk("FBO Identification","BLOCK",0.95,"No food business operator name or address provided. This is a mandatory particular.","Art. 9(1)(h), Art. 8, Reg. 1169/2011","Provide the full business name and address of the FBO under whose name the food is marketed. For EU-manufactured products, this is the manufacturer or brand owner. For imports from third countries, the EU importer must be identified.")
  );

  // 4. INGREDIENT LIST
  if (!d.ingredients.length) {
    if (isAlc && d.category === "Wine") checks.push(chk("Ingredient List","FLAG",0.85,"No ingredients provided for wine product. Since 8 December 2023, ingredient listing is mandatory for wine and aromatised wine products under amended Reg. 1308/2013 (CMO), as modified by Reg. 2021/2117. This applies to wines from the 2024 harvest onwards, with transitional rules for existing stock. Ingredients may be provided on the label or via an e-label (QR code linking to a digital record).","Art. 119(1), Reg. 1308/2013 as amended by Reg. 2021/2117; Commission Delegated Reg. 2023/1606","Provide a full ingredient list. For wine, ingredients may be presented on-label or via e-label (electronic label accessible by QR code). The e-label must not collect or track user data and must not display marketing material alongside the mandatory information. Allergen declaration remains mandatory on the physical label regardless of whether e-label is used for other elements. Wines produced and labelled before 8 Dec 2023 may continue to be sold until stocks are exhausted."));
    else if (isAlc) checks.push(chk("Ingredient List","FLAG",0.75,"No ingredients provided for alcoholic beverage. Beverages >1.2% ABV other than wine are currently exempt from mandatory ingredient listing under Art. 16(4) of Reg. 1169/2011. The Commission has committed to proposing mandatory labelling for spirits and beer (Beating Cancer Plan) but no legislation has been adopted yet.","Art. 16(4), Art. 18, Reg. 1169/2011","Prepare an ingredient list now even if exempt. Spirits/beer: legislation is anticipated and spiritsEUROPE members are already implementing voluntary listing. Early compliance avoids costly label redesigns. Even exempt products must still declare allergens if present."));
    else checks.push(chk("Ingredient List","FLAG",0.7,"No ingredients provided. Required for most prepacked foods under Art. 9(1)(b).","Art. 9(1)(b), Art. 18-20, Reg. 1169/2011","Provide full ingredient list headed by 'Ingredients:' in descending order of weight at time of manufacture. Compound ingredients >2% must be broken down into their components (Art. 18(4)), added water must be listed if >5% of finished product, additives must show category name followed by E-number or specific name (Annex VII)."));
  } else {
    const n = d.ingredients.length;
    const hasAdditives = d.ingredients.some(i => /E\d{3}/i.test(i) || /acid|emulsif|stabil|thicken|preserv|antioxid|colour|flavor|sweeten/i.test(i.toLowerCase()));
    checks.push(chk("Ingredient List","PASS",0.75,`${n} ingredients listed. Descending weight order assumed but cannot be verified without weight data.${hasAdditives ? " Additives detected - verify category name precedes each E-number or specific name." : ""}`,"Art. 18-20, Annex VII, Reg. 1169/2011",`On the label: headed by 'Ingredients:'. descending weight order at manufacture. compound ingredients >2% broken down. water listed if >5%. additives formatted as 'category name (E-number or name)' per Annex VII. allergens emphasised (see Allergen check). if product contains nanomaterials, indicate with '[nano]' after ingredient name.`));

    // 4b. ANNEX III MANDATORY WARNINGS
    const ingTxt = d.ingredients.join(" ").toLowerCase();
    const annexIII = [];
    const hasSweetener = /aspartame|acesulfame|sucralose|saccharin|stevia|steviol|cyclamate|e950|e951|e952|e954|e955|e960|e961|e962|sweetener/i.test(ingTxt);
    const hasAspartame = /aspartame|e951/i.test(ingTxt);
    const hasSugar = /sugar|sucrose|glucose|fructose|dextrose|maltose|honey|syrup/i.test(ingTxt);
    const hasCaffeine = /caffeine/i.test(ingTxt);

    if (hasSweetener && hasSugar) annexIII.push(`Contains both sugar(s) and sweetener(s) → label must state 'with sugar(s) and sweetener(s)' near the product name (Annex III, Part A, 2.3)`);
    else if (hasSweetener) annexIII.push(`Contains sweetener(s) → label must state 'with sweetener(s)' near the product name (Annex III, Part A, 2.1)`);

    if (hasAspartame) annexIII.push(`Contains aspartame (E951), a source of phenylalanine → label must state 'contains a source of phenylalanine' (Annex III, Part A, 2.4). Critical for consumers with phenylketonuria (PKU).`);

    if (hasCaffeine && !isAlc && !["Spirit","Wine","Beer"].includes(d.category)) {
      annexIII.push(`Contains caffeine → if >150mg/L, label must state 'High caffeine content. Not recommended for children or pregnant or breast-feeding women' followed by caffeine content in mg/100ml (Annex III, Part B, 4.1). This applies to all beverages except tea/coffee-based ones where 'tea' or 'coffee' appears in the name.`);
    }

    if (annexIII.length) {
      checks.push(chk("Annex III Warnings","FLAG",0.8,`Mandatory additional labelling requirements detected under Annex III of Reg. 1169/2011:\n${annexIII.join("\n")}`,"Annex III, Reg. 1169/2011","These warnings are in ADDITION to standard mandatory information. They must appear on the label - their absence is a common enforcement finding. The 'with sweetener(s)' statement must be near the product name, not buried in the ingredient list. The phenylalanine warning must also appear on the label. These are frequently checked by enforcement authorities and are common causes of product recalls."));
    }
  }

  // 5. ALLERGEN DECLARATION
  const detected = scanAllergens(d.ingredients);
  document.querySelectorAll('.allergen-item').forEach(el => el.classList.remove('detected'));
  for (const k of Object.keys(detected)) {
    const el = document.getElementById('ai_'+k);
    if (el) el.classList.add('detected');
  }

  if (!d.ingredients.length) {
    checks.push(chk("Allergen Declaration","FLAG",0.5,"Cannot scan for allergens without an ingredient list.","Art. 21, Annex II, Reg. 1169/2011","Provide ingredients to enable automated allergen cross-check. Even for exempt products (e.g. alcoholic beverages), if allergens are present they must be declared."));
  } else {
    const undeclared = [];
    for (const [k,info] of Object.entries(detected)) {
      if (!d.declaredAllergens.has(k)) undeclared.push(info.name);
    }
    if (undeclared.length) {
      const detailLines = undeclared.map(nm => {
        const key = Object.keys(detected).find(k => detected[k].name === nm);
        return key ? `${nm} (detected via: ${detected[key].hits.join(", ")})` : nm;
      });
      checks.push(chk("Allergen Declaration","BLOCK",0.9,`POTENTIALLY UNDECLARED ALLERGENS found in ingredient scan:\n${detailLines.join("\n")}\nThese substances appear in your ingredient list but are not ticked as declared in the Allergens section.`,"Art. 21, Annex II, Reg. 1169/2011",`First, tick the missing allergens in the Allergens section above if they are genuinely present. If the keyword match is a false positive (for instance, 'coconut' is not a tree nut under Annex II), you can safely disregard it. On the physical label, every allergen must stand out from the rest of the ingredient list - bold, CAPITALS, or a contrasting font per Art. 21(1)(b). For single-ingredient foods with no ingredient list, use a 'Contains:' statement instead.`));
    } else if (Object.keys(detected).length) {
      const detailLines = Object.entries(detected).map(([k,v]) => `${v.name} (matched: ${v.hits.join(", ")})`);
      checks.push(chk("Allergen Declaration","PASS",0.85,`All detected allergens are declared. Cross-reference:\n${detailLines.join("\n")}\nVerify they are emphasised in the ingredient list through typeset clearly distinguished from other ingredients (Art. 21(1)(b)).`,"Art. 21, Annex II, Reg. 1169/2011",`On the actual label, each allergen is emphasised (bold, CAPS, or underline) within the ingredient list. Emphasis is consistent across all allergens. If product is also sold non-prepacked (e.g. in food service), allergen info must be available in writing before purchase. Consider whether voluntary precautionary allergen labelling ('may contain traces of…') is warranted based on your production environment and HACCP allergen risk assessment.`));
    } else {
      checks.push(chk("Allergen Declaration","PASS",0.8,"No Annex II allergens detected in ingredient scan and none declared.","Art. 21, Annex II, Reg. 1169/2011","Keyword scan found no matches, but this does not guarantee allergen absence. Look out for ingredients not in the list that may be present (processing aids, carry-over additives). shared production line risks - if cross-contamination is possible, consider precautionary 'may contain' labelling based on a documented risk assessment. Note: precautionary labelling is not regulated by Reg. 1169/2011 but is expected by retailers and enforced by authorities if used carelessly."));
    }
  }

  // 6. DATE MARKING
  const dateExempt = (isAlc && d.abv >= 10) || DATE_EXEMPT_CATS.includes(d.category);
  if (d.dateType === "bbd" || d.dateType === "use_by") {
    const label = d.dateType === "use_by" ? "'Use by'" : "'Best before'";
    checks.push(chk("Date Marking","PASS",0.85,`${label} date type selected. ${d.dateType === "use_by" ? "Correct for highly perishable foods that may constitute a health risk after a short period. After this date, the food is deemed unsafe under Art. 14 of Reg. 178/2002 and must not be sold." : "Appropriate for foods that remain safe but may lose organoleptic quality over time. Verify 'Best before' vs 'Use by' is appropriate - misapplication is a common enforcement finding."}`,
      "Art. 9(1)(f), Art. 24, Annex X, Reg. 1169/2011",d.dateType === "use_by" ? "On the label: storage conditions clearly stated alongside or linked to the date. 'Use by' date on each individual portion if sold as multi-pack. food must be withdrawn from sale after this date - selling past 'use by' is a criminal offence in most Member States. if freezing is possible before expiry, include instructions: 'Suitable for home freezing. If frozen, use within X months. Do not refreeze after thawing.'." : "Format: 'Best before DD/MM/YYYY' for shelf life <3 months, or 'Best before end MM/YYYY' (or 'YYYY') for shelf life >3 months. Storage conditions must be stated if they affect durability. Product can technically still be sold after 'best before' if the FBO can demonstrate safety - but many retailers refuse to stock past-date products."));
  } else if (d.dateType === "exempt" || dateExempt) {
    checks.push(chk("Date Marking","PASS",0.8,"Date marking exemption claimed. Annex X exemptions include: beverages >10% ABV, fresh uncut fruit and vegetables, bakers' wares normally consumed within 24h, vinegar, cooking/table salt, solid sugar, confectionery of nearly only flavoured/coloured sugars, and chewing gum.","Art. 24(2), Annex X, Reg. 1169/2011","Double-check the exemption genuinely applies. Common issue: flavoured spirits or cream liqueurs may not qualify if ABV is <10% or they contain perishable dairy ingredients. Vinegar-based dressings containing other ingredients are not exempt (only pure vinegar qualifies). When in doubt, include a 'Best before' date - there is no penalty for providing more information than required."));
  } else {
    checks.push(chk("Date Marking","FLAG",0.85,"No date marking provided and no exemption declared. Date of minimum durability is a mandatory particular.","Art. 9(1)(f), Art. 24, Reg. 1169/2011","Choose the correct date type: 'Use by' for microbiologically perishable foods that could pose an immediate danger to health (base the decision on shelf life studies and safety criteria in Reg. 2073/2005); 'Best before' for all other foods. If genuinely exempt under Annex X (beverages >10% ABV, fresh fruit/veg, vinegar, salt, sugar, etc.), select the exemption option in the form."));
  }

  // 7. LOT IDENTIFICATION
  checks.push(d.lot
    ? chk("Lot Identification","PASS",0.85,`Lot ID: ${d.lot}. Must be preceded by 'L' or be clearly distinguishable from other date/code markings on the label.`,"Dir. 2011/91/EU",`Check: preceded by the letter 'L' unless clearly distinct from other codes. placed near the date marking where possible. your internal traceability system can link this lot to raw material receipts, production records, and distribution records as required by Art. 18 of Reg. 178/2002. Without reliable lot-to-batch traceability, a targeted recall becomes a full product recall - which multiplies the cost.`)
    : chk("Lot Identification","FLAG",0.8,"No lot identification provided. Required for all marketed food under Dir. 2011/91/EU.","Dir. 2011/91/EU","Add a lot code preceded by 'L' (e.g. L2025-0312). Exemptions are very narrow: individual portions of ice cream, products whose date marking includes day and month (can serve as lot), and pre-packed items sold at point of sale individually. In practice, lot marking should always be present - it is essential for efficient recall management.")
  );

  // 8. NUTRITION DECLARATION
  const isWine = d.category === "Wine";
  const nutriExempt = (NUTRITION_EXEMPT.includes(d.category) || (isAlc && !isWine));
  if (d.nutriProvided === "yes") {
    const big7 = [d.nKj, d.nKcal, d.nFat, d.nSat, d.nCarb, d.nSugar, d.nProt, d.nSalt];
    const filled = big7.filter(v => v !== null).length;
    if (filled >= 7) {
      let issues = [];
      if (d.nSat !== null && d.nFat !== null && d.nSat > d.nFat) issues.push("Saturates exceed total fat - saturated fatty acids are a subset of total fat and cannot be higher");
      if (d.nSugar !== null && d.nCarb !== null && d.nSugar > d.nCarb) issues.push("Sugars exceed total carbohydrate - sugars are a subset of total carbohydrate and cannot be higher");
      if (d.nSalt !== null && d.nSalt > 100) issues.push("Salt value appears unrealistically high - verify units (should be grams per 100g/100ml)");
      if (d.nKj !== null && d.nKcal !== null && d.nKcal > 10) {
        const ratio = d.nKj / d.nKcal;
        if (Math.abs(ratio - 4.184) > 0.6) issues.push(`Energy values may be inconsistent: ${d.nKj}kJ ÷ ${d.nKcal}kcal = ratio ${ratio.toFixed(2)} (expected ≈4.184). Check for transcription errors.`);
      }
      if (issues.length) {
        checks.push(chk("Nutrition Declaration","FLAG",0.85,`Nutrition data provided but logical inconsistencies detected:\n${issues.join("\n")}`,"Art. 29-35, Reg. 1169/2011","Recheck values against the original nutritional analysis report. Common causes: lab report transcription error. Values from different analytical methods mixed. Units confused (mg vs g for salt, kJ vs kcal swapped). Consider re-analysis if inconsistencies persist."));
      } else {
        checks.push(chk("Nutrition Declaration","PASS",0.85,`All mandatory elements provided (energy kJ + kcal, fat, saturates, carbohydrate, sugars, protein, salt). Values appear logically consistent.${d.nKj && d.nKcal ? " Energy ratio kJ:kcal = " + (d.nKj/d.nKcal).toFixed(2) + " (expected ≈4.18)." : ""}`,"Art. 29-35, Annex XV, Reg. 1169/2011",`Present in tabular format where space permits (Art. 34); linear format only where space is insufficient. Values per ${perUnit} are mandatory. Per-portion values are optional and supplementary (Art. 33). Values must be based on analysis, calculation from known ingredients, or established food composition databases (Art. 31). Tolerance: generally ±20% for macronutrients under EU Commission guidance.`));
      }
    } else {
      checks.push(chk("Nutrition Declaration","FLAG",0.8,`Only ${filled}/8 mandatory nutrition fields provided (energy kJ, energy kcal, fat, saturates, carbohydrate, sugars, protein, salt). All values are required.`,"Art. 30(1), Reg. 1169/2011","Complete all mandatory fields. Energy must be expressed in BOTH kJ and kcal. The order on the label must follow Art. 34(1): Energy → Fat → of which saturates → Carbohydrate → of which sugars → Protein → Salt. Additional elements (fibre, polyols, starch, vitamins, minerals) may be declared voluntarily."));
    }
  } else if (d.nutriProvided === "exempt" || nutriExempt) {
    if (isWine) {
      checks.push(chk("Nutrition Declaration","FLAG",0.85,`Wine product: nutrition declaration has been mandatory since 8 December 2023 under amended Reg. 1308/2013 (CMO). The exemption under Annex V of Reg. 1169/2011 no longer applies to wine and aromatised wine products. Energy value must appear on the physical label; the full nutrition declaration may be provided via e-label.`,"Art. 119(1), Reg. 1308/2013 as amended by Reg. 2021/2117; Commission Delegated Reg. 2023/1606","At minimum, energy value (in kJ and kcal) must appear on the physical label. The full Big 7 nutrition declaration may be provided on-label or via e-label (QR code). The same e-label rules apply as for the ingredient list: no data collection, no marketing material alongside mandatory information. Wines produced and labelled before 8 Dec 2023 under the old rules may continue to be sold until stocks are exhausted."));
    } else {
      checks.push(chk("Nutrition Declaration","PASS",0.75,`Nutrition declaration exemption claimed. Annex V exemptions include: beverages >1.2% ABV (except wine since Dec 2023), unprocessed single-ingredient products, water, herbs/spices/salt/vinegar, tea/coffee without added ingredients, food supplements (governed by Dir. 2002/46/EC instead).`,"Art. 16, Annex V, Reg. 1169/2011",`If nutrition information is voluntarily provided on an exempt product, it must follow the full mandatory format (all Big 7, tabular, per ${perUnit}). A partial declaration such as 'only 95 calories' triggers the obligation to provide the full table. If any nutrition claim is made, the full declaration becomes mandatory regardless of exemption status (Art. 49, Reg. 1924/2006).`));
    }
  } else {
    checks.push(chk("Nutrition Declaration","BLOCK",0.85,"No nutrition declaration provided and no exemption claimed. Mandatory for all prepacked foods since 13 December 2016.","Art. 9(1)(l), Art. 29, Reg. 1169/2011","Provide the Big 7 in this order: Energy (kJ and kcal), Fat, of which Saturates, Carbohydrate, of which Sugars, Protein, Salt. Values must be per 100g or 100ml. Obtain values through: laboratory analysis (most reliable), calculation from known ingredient composition, or established food composition databases. Tabular format required where space permits."));
  }

  // 8b. NUTRI-SCORE ESTIMATION
  if (d.nutriProvided === "yes" && d.nKcal !== null && d.nSugar !== null && d.nSat !== null && d.nSalt !== null && d.nProt !== null) {
    const isBev = ["Beverage","Juice"].includes(d.category) || catLow.includes("drink") || catLow.includes("beverage") || catLow.includes("juice");
    const ns = calcNutriScore(d, isLiquid, isBev && !isAlc);
    if (ns) {
      const hasFVN = d.nFVN !== null;
      const hasFibre = d.nFibre !== null;
      const caveat = (!hasFVN || !hasFibre) ? ` Note: ${!hasFVN && !hasFibre ? "fibre and fruit/veg/nut % were not provided" : !hasFVN ? "fruit/veg/nut % was not provided" : "fibre was not provided"} - actual Nutri-Score may differ. Provide these values in the optional fields for a more accurate estimate.` : "";
      checks.push(chk("Nutri-Score Estimate","FLAG",0.6,`Estimated Nutri-Score: ${ns.grade} (raw score: ${ns.score}). Calculated using the 2023 updated algorithm (${isBev && !isAlc ? "beverage" : "solid food"} category).${caveat}`,"Nutri-Score algorithm (voluntary labelling scheme)","Nutri-Score is voluntary in the EU but increasingly expected by Dutch, French, Belgian, German, and Spanish retailers - especially for private label. If your estimated grade is D or E, reformulating to reduce sugar, salt, or saturated fat is worth considering, as is increasing fibre or fruit/vegetable content. Nutri-Score applies per 100g/100ml, not per serving. The 2023 algorithm is harder on sweeteners in beverages than the previous version. Note: the official Nutri-Score requires registration via Santé Publique France - using the logo without registration is not permitted."));
    }
  }

  // 9. ABV (if applicable)
  if (isAlc) {
    const tolerance = d.category === "Spirit" ? 0.5 : 0.3;
    checks.push(chk("ABV Declaration","PASS",0.9,`ABV declared at ${d.abv}% vol. Must appear as 'X.X% vol' with no more than one decimal place. Annex XII tolerance: ±${tolerance}% vol for ${d.category === "Spirit" ? "spirits" : "this category"}.`,"Art. 9(1)(k), Art. 28, Annex XII, Reg. 1169/2011",`On the label, format as '${d.abv}% vol' preceded by 'alc.' or 'alcohol'. Maximum one decimal place. Ensure your actual ABV (verified by analysis at 20°C) falls within ${(d.abv - tolerance).toFixed(1)}–${(d.abv + tolerance).toFixed(1)}% vol. Must appear in same field of vision as product name and net quantity.`));

    const sub = (d.subcategory||"").toLowerCase();
    if (SPIRIT_MIN_ABV[sub] && d.abv < SPIRIT_MIN_ABV[sub]) {
      checks.push(chk("Spirit Category ABV","BLOCK",0.95,`ABV ${d.abv}% is below the minimum ${SPIRIT_MIN_ABV[sub]}% required for '${d.subcategory}' under Annex I of Reg. 2019/787. The product cannot legally be sold as '${d.subcategory}'.`,"Annex I, Reg. 2019/787",`You could increase ABV to ≥${SPIRIT_MIN_ABV[sub]}% vol through reformulation. reclassify as a 'spirit drink' (minimum 15% ABV) or 'other spirit' if compositional requirements are not met. if blended with non-alcoholic components, consider whether the product falls under a different designation. Do not use the category name on the label if the ABV threshold is not met - this will lead to market withdrawal.`));
    } else if (d.category === "Spirit" && SPIRIT_MIN_ABV[sub]) {
      checks.push(chk("Spirit Category ABV","PASS",0.8,`ABV ${d.abv}% meets minimum ${SPIRIT_MIN_ABV[sub]}% for '${d.subcategory}'. Note: ABV alone does not guarantee category compliance - each spirit category has compositional and production method requirements beyond minimum ABV.`,"Annex I, Reg. 2019/787",`Check full category compliance: raw materials match the Annex I definition (e.g. gin must derive its predominant flavour from juniper berries). Production method complies (e.g. 'London Dry Gin' requires redistillation, no artificial flavourings, no colourants, maximum 0.1g sweetener per litre of finished product). Sweetening limits where applicable. Laboratory analysis recommended to confirm all parameters.`));
    }
  } else if (["Spirit","Wine","Beer"].includes(d.category)) {
    checks.push(chk("ABV Declaration","BLOCK",0.9,"Alcoholic beverage category selected but no ABV provided. ABV is a mandatory particular for all beverages >1.2% ABV.","Art. 9(1)(k), Reg. 1169/2011","Declare ABV as 'alc. X.X% vol' based on laboratory analysis at 20°C. For spirits, the distillation strength and final ABV must comply with the category definition in Reg. 2019/787. For wine, ABV must be consistent with the declared wine category."));
  }

  // 10. CLAIMS
  if (d.claims.length) {
    const healthKW = ["health","cure","treat","prevent","disease","medical","therapeutic","healing","remedy","immune","protects","reduces risk","lowers cholesterol","supports","maintains","contributes to"];
    const nutriKW = ["low fat","low sugar","sugar free","no added sugar","high fibre","high fiber","source of","rich in","high in","low calorie","light","lite","reduced","free from","fat free","low sodium","low salt","high protein","no artificial","natural source","enriched","fortified","added vitamin","added mineral","with vitamin","with calcium","with iron","with omega"];
    const hc = d.claims.filter(c => healthKW.some(k => c.toLowerCase().includes(k)));
    const nc = d.claims.filter(c => nutriKW.some(k => c.toLowerCase().includes(k)));
    const marketing = d.claims.filter(c => !hc.includes(c) && !nc.includes(c));

    if (hc.length && isAlc) {
      checks.push(chk("Health Claims","BLOCK",0.95,`Health claims on alcoholic beverage (>1.2% ABV): "${hc.join('", "')}". Health claims are prohibited on beverages >1.2% ABV. This is an absolute prohibition with no exceptions.`,"Art. 4(3), Reg. 1924/2006","Remove all health claims from the label, website, and all marketing materials. This includes indirect health claims on social media, point-of-sale materials, and third-party advertising. The prohibition covers any claim that states, suggests, or implies a relationship between the product and health. Some Member States also prosecute implied health claims (e.g. 'antioxidant-rich botanicals' on a spirit label)."));
    } else if (hc.length) {
      checks.push(chk("Health Claims","FLAG",0.85,`Potential health claims detected: "${hc.join('", "')}". All health claims must be authorised under Art. 13(1) (function claims) or Art. 14 (disease risk reduction/children's health claims). Only the exact wording listed in the EU Register is permitted.`,"Art. 10, Art. 13-14, Reg. 1924/2006","Start by checking each claim against the EU Register (ec.europa.eu/food/food-feed-portal/screen/health-claims/eu-register). Use the exact authorised wording - even minor deviations can make the claim non-compliant. Each health claim must be accompanied by a statement on the importance of a varied and balanced diet, the quantity needed for the claimed benefit, and any population restrictions (Art. 10(2)). The food must also contain a 'significant amount' of the relevant nutrient - at least 15% of Reference Intake per 100g/100ml or per serving."));
    }

    if (nc.length) {
      if (isAlc) {
        checks.push(chk("Nutrition Claims","FLAG",0.85,`Nutrition claims on alcoholic beverage: "${nc.join('", "')}". For beverages >1.2% ABV, only 'low alcohol', 'reduced alcohol', and 'reduced energy' claims are permitted.`,"Art. 4(3), Reg. 1924/2006","Remove any non-permitted nutrition claims. The only claims allowed on alcoholic beverages >1.2% ABV relate to reductions in alcohol or energy content. Claims like 'low sugar', 'natural', or 'source of vitamins' are not permitted on alcoholic beverages."));
      } else {
        const claimIssues = [];
        nc.forEach(c => {
          const cl = c.toLowerCase();
          if ((cl.includes("high in fibre")||cl.includes("high in fiber")||cl.includes("high fibre")||cl.includes("high fiber")||cl.includes("rich in fibre")||cl.includes("rich in fiber"))) { claimIssues.push(`"${c}" - requires ≥6g fibre/${perUnit} or ≥3g fibre/100kcal. Fibre is not part of the mandatory nutrition declaration - confirm via nutritional analysis or food composition data.`); }
          else if ((cl.includes("source of fibre")||cl.includes("source of fiber"))) { claimIssues.push(`"${c}" - requires ≥3g fibre/${perUnit} or ≥1.5g fibre/100kcal. Confirm via nutritional analysis.`); }
          else if (cl.includes("low fat") && d.nFat !== null) { const limit = isLiquid ? 1.5 : 3; if (d.nFat > limit) claimIssues.push(`"${c}" - requires ≤${limit}g fat/${perUnit}${isLiquid ? " (liquid threshold applied)" : ""}. Declared fat: ${d.nFat}g. CONDITION NOT MET.`); else claimIssues.push(`"${c}" - requires ≤${limit}g fat/${perUnit}${isLiquid ? " (liquid threshold)" : ""}. Declared fat: ${d.nFat}g. Condition appears met.`); }
          else if ((cl.includes("fat free")||cl.includes("fat-free")) && d.nFat !== null) { if (d.nFat > 0.5) claimIssues.push(`"${c}" - requires ≤0.5g fat/${perUnit}. Declared fat: ${d.nFat}g. CONDITION NOT MET. Note: claims expressed as 'X% fat-free' are prohibited by the Annex.`); }
          else if (cl.includes("low sugar") && d.nSugar !== null) { const limit = isLiquid ? 2.5 : 5; if (d.nSugar > limit) claimIssues.push(`"${c}" - requires ≤${limit}g sugars/${perUnit}${isLiquid ? " (liquid threshold applied)" : ""}. Declared sugars: ${d.nSugar}g. CONDITION NOT MET.`); else claimIssues.push(`"${c}" - requires ≤${limit}g sugars/${perUnit}. Declared sugars: ${d.nSugar}g. Condition appears met.`); }
          else if ((cl.includes("sugar free")||cl.includes("sugar-free")) && d.nSugar !== null) { if (d.nSugar > 0.5) claimIssues.push(`"${c}" - requires ≤0.5g sugars/${perUnit}. Declared sugars: ${d.nSugar}g. CONDITION NOT MET.`); }
          else if ((cl.includes("no added sugar")||cl.includes("no added sugars"))) { claimIssues.push(`"${c}" - product must not contain any added mono/disaccharides or any food used for its sweetening properties. If the product naturally contains sugars, the label MUST state: 'CONTAINS NATURALLY OCCURRING SUGARS'.`); }
          else if (cl.includes("low salt")||cl.includes("low sodium")) { if (d.nSalt !== null) { if (d.nSalt > 0.3) claimIssues.push(`"${c}" - requires ≤0.12g sodium/${perUnit} (equivalent to ≤0.3g salt). Declared salt: ${d.nSalt}g. CONDITION NOT MET.`); else claimIssues.push(`"${c}" - requires ≤0.12g sodium/${perUnit} (≈≤0.3g salt). Declared salt: ${d.nSalt}g. Condition appears met.`); } }
          else if (cl.includes("high protein")||cl.includes("high in protein")||cl.includes("rich in protein")) { if (d.nProt !== null && d.nKcal !== null && d.nKcal > 0) { const protE = (d.nProt*4/d.nKcal)*100; if (protE < 20) claimIssues.push(`"${c}" - requires ≥20% of energy from protein. Calculation: ${d.nProt}g × 4 kcal/g ÷ ${d.nKcal}kcal × 100 = ${protE.toFixed(1)}%. CONDITION NOT MET.`); else claimIssues.push(`"${c}" - requires ≥20% of energy from protein. Calculation: ${d.nProt}g × 4 ÷ ${d.nKcal}kcal × 100 = ${protE.toFixed(1)}%. Condition appears met.`); } }
          else if (cl.includes("source of protein")) { if (d.nProt !== null && d.nKcal !== null && d.nKcal > 0) { const protE = (d.nProt*4/d.nKcal)*100; if (protE < 12) claimIssues.push(`"${c}" - requires ≥12% of energy from protein. Calculation: ${d.nProt}g × 4 ÷ ${d.nKcal}kcal × 100 = ${protE.toFixed(1)}%. CONDITION NOT MET.`); else claimIssues.push(`"${c}" - requires ≥12% of energy from protein. Calculation: ${d.nProt}g × 4 ÷ ${d.nKcal}kcal × 100 = ${protE.toFixed(1)}%. Condition appears met.`); } }
          else if (cl.includes("low calorie")||cl.includes("low energy")) { const limit = isLiquid ? 20 : 40; if (d.nKcal !== null) { if (d.nKcal > limit) claimIssues.push(`"${c}" - requires ≤${limit}kcal/${perUnit}${isLiquid ? " (liquid threshold)" : ""}. Declared energy: ${d.nKcal}kcal. CONDITION NOT MET.`); else claimIssues.push(`"${c}" - requires ≤${limit}kcal/${perUnit}. Declared energy: ${d.nKcal}kcal. Condition appears met.`); } }
          else if (cl.includes("light")||cl.includes("lite")) { claimIssues.push(`"${c}" - 'light/lite' requires the same conditions as 'reduced' (≥30% reduction vs comparable products) AND the label must state exactly what characteristic makes the food 'light'. Identify a reference product for comparison.`); }
          else if (cl.includes("reduced")) { claimIssues.push(`"${c}" - requires ≥30% reduction in the relevant nutrient compared to a similar product. Must identify the reference product and quantify the reduction on the label.`); }
          else if (cl.includes("enriched")||cl.includes("fortified")||cl.includes("added vitamin")||cl.includes("added mineral")) { claimIssues.push(`"${c}" - implies addition of vitamins/minerals. Under Reg. 1925/2006 (addition of nutrients to foods), added vitamins/minerals must be from forms listed in Annex II, and the product must provide a 'significant amount' (≥15% of Reference Intake per 100g/100ml or per serving, Annex XIII, Reg. 1169/2011). Nutrition declaration is mandatory and must include the added nutrients.`); }
          else if (cl.includes("with vitamin")||cl.includes("with calcium")||cl.includes("with iron")||cl.includes("with omega")||cl.includes("source of vitamin")||cl.includes("source of calcium")||cl.includes("source of iron")||cl.includes("rich in vitamin")||cl.includes("rich in calcium")||cl.includes("rich in iron")) {
            // Try to verify against actual micronutrient data
            const isHigh = cl.includes("rich in") || cl.includes("high in");
            const threshold = isHigh ? 30 : 15; // % of RI
            const thresholdLabel = isHigh ? "≥30%" : "≥15%";
            const claimType = isHigh ? "High in / Rich in" : "Source of";
            let verified = false;
            const microChecks = [];
            if ((cl.includes("vitamin d")||cl.includes("vit d")) && d.nVitD !== null) { const pct = (d.nVitD/RI.vitD.ri)*100; microChecks.push(`Vitamin D: ${d.nVitD}µg = ${pct.toFixed(0)}% RI (need ${thresholdLabel}). ${pct >= threshold ? "MET ✓" : "NOT MET"}`); verified = true; }
            if ((cl.includes("vitamin c")||cl.includes("vit c")) && d.nVitC !== null) { const pct = (d.nVitC/RI.vitC.ri)*100; microChecks.push(`Vitamin C: ${d.nVitC}mg = ${pct.toFixed(0)}% RI (need ${thresholdLabel}). ${pct >= threshold ? "MET ✓" : "NOT MET"}`); verified = true; }
            if (cl.includes("calcium") && d.nCalcium !== null) { const pct = (d.nCalcium/RI.calcium.ri)*100; microChecks.push(`Calcium: ${d.nCalcium}mg = ${pct.toFixed(0)}% RI (need ${thresholdLabel}). ${pct >= threshold ? "MET ✓" : "NOT MET"}`); verified = true; }
            if (cl.includes("iron") && d.nIron !== null) { const pct = (d.nIron/RI.iron.ri)*100; microChecks.push(`Iron: ${d.nIron}mg = ${pct.toFixed(0)}% RI (need ${thresholdLabel}). ${pct >= threshold ? "MET ✓" : "NOT MET"}`); verified = true; }
            if ((cl.includes("vitamin b12")||cl.includes("vit b12")||cl.includes("b12")) && d.nVitB12 !== null) { const pct = (d.nVitB12/RI.vitB12.ri)*100; microChecks.push(`Vitamin B12: ${d.nVitB12}µg = ${pct.toFixed(0)}% RI (need ${thresholdLabel}). ${pct >= threshold ? "MET ✓" : "NOT MET"}`); verified = true; }
            if ((cl.includes("folic")||cl.includes("folate")) && d.nFolate !== null) { const pct = (d.nFolate/RI.folate.ri)*100; microChecks.push(`Folic acid: ${d.nFolate}µg = ${pct.toFixed(0)}% RI (need ${thresholdLabel}). ${pct >= threshold ? "MET ✓" : "NOT MET"}`); verified = true; }
            if (cl.includes("zinc") && d.nZinc !== null) { const pct = (d.nZinc/RI.zinc.ri)*100; microChecks.push(`Zinc: ${d.nZinc}mg = ${pct.toFixed(0)}% RI (need ${thresholdLabel}). ${pct >= threshold ? "MET ✓" : "NOT MET"}`); verified = true; }
            if (cl.includes("potassium") && d.nPotassium !== null) { const pct = (d.nPotassium/RI.potassium.ri)*100; microChecks.push(`Potassium: ${d.nPotassium}mg = ${pct.toFixed(0)}% RI (need ${thresholdLabel}). ${pct >= threshold ? "MET ✓" : "NOT MET"}`); verified = true; }
            if (verified) { claimIssues.push(`"${c}" (${claimType}) - ${thresholdLabel} of Reference Intake required per ${perUnit}:\n${microChecks.join("\n")}`); }
            else { claimIssues.push(`"${c}" - ${claimType} claim requires ${thresholdLabel} of Reference Intake per ${perUnit} (Annex XIII, Reg. 1169/2011). Enter the relevant micronutrient value in the optional Vitamins & Minerals section to enable automated verification.`); }
          }
          else if (cl.includes("no artificial")) { claimIssues.push(`"${c}" - implies all ingredients and processing aids are of natural origin. Verify no synthetic additives, flavourings, or colourings are present. 'No artificial colours or flavours' is more defensible than blanket 'no artificial'.`); }
        });
        if (claimIssues.length) {
          checks.push(chk("Nutrition Claims","FLAG",0.85,`Nutrition claims verified against Annex conditions of Reg. 1924/2006 (${isLiquid ? "liquid" : "solid"} thresholds applied):\n${claimIssues.join("\n")}`,"Annex, Reg. 1924/2006",`Making any nutrition claim triggers mandatory nutrition declaration even if otherwise exempt (Art. 49, Reg. 1924/2006). Claims must relate to the food as sold (per ${perUnit}). The prefix 'naturally' or 'natural' may be used if the food inherently meets the condition. Documentary evidence of compliance should be maintained for each claim.`));
        } else {
          checks.push(chk("Nutrition Claims","FLAG",0.8,`Nutrition claims detected: "${nc.join('", "')}". Each must meet quantitative conditions in the Annex of Reg. 1924/2006.`,"Annex, Reg. 1924/2006","Enter nutrition data in the Nutrition tab to enable automated verification against Annex thresholds. Remember: nutrition declaration becomes mandatory when any nutrition claim is made."));
        }
      }
    }

    if (marketing.length) {
      const mkDetail = marketing.map(c => {
        const cl = c.toLowerCase();
        if (cl.includes("handcrafted")||cl.includes("hand made")||cl.includes("handmade")||cl.includes("artisan")||cl.includes("artisanal")) return `"${c}" - implies manual production methods. If any stage is fully automated or industrial-scale, this claim is potentially misleading under Art. 7(1)(a). Document exactly which production steps are genuinely performed by hand.`;
        if (cl.includes("traditional")||cl.includes("traditionally")) return `"${c}" - implies long-established production methods or recipes. Must be substantiated with evidence of historical practice. Some Member States have specific legal definitions. Consider TSG registration under Reg. 1151/2012 for formal protection.`;
        if (cl.includes("natural")||cl.includes("all natural")) return `"${c}" - no harmonised EU definition of 'natural' for foods exists. Widely accepted interpretation: ingredients must not contain artificial/synthetic components and processing must not go beyond what is needed to make the food suitable for consumption. This claim attracts high enforcement scrutiny - substantiate carefully.`;
        if (cl.includes("premium")||cl.includes("finest")||cl.includes("superior")) return `"${c}" - comparative/superlative claims must be objectively substantiated. What specific quality attribute makes this product '${c.toLowerCase()}'? Document the comparison basis.`;
        if (cl.includes("small batch")) return `"${c}" - no legal definition in EU law. Define your batch size internally and be prepared to justify this characterisation if challenged by enforcement. If you produce large volumes but bottle in small runs, the claim may be challenged as misleading.`;
        if (cl.includes("no artificial")) return `"${c}" - implies all ingredients and processing aids are of natural origin. Verify no synthetic additives, flavourings, or colourings are present. 'No artificial colours or flavours' is more defensible than a blanket 'no artificial' claim because it is more specific.`;
        if (cl.includes("organic") && d.organic !== "yes") return `"${c}" - if this refers to organic certification, select 'Yes' in the Organic field above. The term 'organic' is legally protected under Reg. 2018/848 and cannot be used without certification.`;
        return `"${c}" - must not mislead the consumer about the food's characteristics, properties, composition, or method of production (Art. 7(1)(a)). Maintain substantiation evidence on file.`;
      });
      checks.push(chk("Marketing Claims","FLAG",0.6,`Marketing claims assessed under general fair information requirements:\n${mkDetail.join("\n")}`,"Art. 7, Reg. 1169/2011; Art. 6-7, Dir. 2005/29/EC","These claims sit outside Reg. 1924/2006 (not nutrition or health claims) but must comply with Art. 7 of Reg. 1169/2011 - labelling must not mislead about characteristics, composition, or origin - and Dir. 2005/29/EC (Unfair Commercial Practices), which prohibits misleading actions and omissions. maintain a substantiation file for each claim with documentary evidence supporting its accuracy."));
    }
  } else {
    checks.push(chk("Claims","PASS",0.9,"No nutrition, health, or marketing claims declared.","Reg. 1924/2006; Art. 7, Reg. 1169/2011","Note: even without explicit claims, product presentation (images, colours, branding) can constitute implied claims. A picture of fresh fruit on packaging may imply fruit content - ensure imagery is consistent with actual composition. Product names containing nutrient references (e.g. 'Protein Bar') may trigger nutrition claim requirements."));
  }

  // 11. GI CHECK
  if (d.gi !== "no") {
    const giType = d.gi === "pdo" ? "PDO" : d.gi === "pgi" ? "PGI" : "TSG";
    const giLogo = giType === "PDO" ? "red/yellow PDO" : giType === "PGI" ? "blue/yellow PGI" : "blue/yellow TSG";
    checks.push(chk("Geographic Indication","FLAG",0.5,`${giType} claimed: "${d.giName||"(not specified)"}". Registration must be confirmed in the eAmbrosia/GIView database. The product must conform to the registered product specification in all respects.`,
      `Reg. (EU) 1151/2012${d.category==="Spirit" ? "; Art. 34-42, Reg. 2019/787" : ""}`,
      `To verify: Search eAmbrosia (ec.europa.eu/agriculture/eambrosia) to confirm the name is registered and the registration type matches your claim (${giType}). obtain and review the full product specification - compliance with geographical area, raw materials, production method, and organoleptic characteristics is mandatory. Display the correct EU symbol (${giLogo} logo) on the label - mandatory for EU-produced products. If a product uses a GI ingredient but is not itself a GI product, strict rules on evocation apply - you cannot imply GI status through similar naming, imagery, or packaging style.`));
  }

  // 12. FONT SIZE & LEGIBILITY
  if (d.surface !== null) {
    if (d.surface < 10) {
      checks.push(chk("Font Size & Legibility","FLAG",0.85,`Package surface ${d.surface} cm² (<10 cm²): Art. 16(2) applies. The mandatory particulars under Art. 9(1) that must still appear are: product name, allergen declaration, net quantity, date marking, and any specific conditions of use. The ingredient list may be provided through other means or made available at the consumer's request. The nutrition declaration may be omitted entirely.`,"Art. 13(3), Art. 16(2), Reg. 1169/2011","Minimum x-height is 0.9mm. For the ingredient list, Art. 16(2) allows 'other means' such as outer packaging, attached leaflet, or request-based provision at point of sale. This does not extend to the nutrition declaration - if omitted under Art. 16(2), there is no obligation to provide it elsewhere unless a nutrition or health claim is made (Art. 49, Reg. 1924/2006). Allergen emphasis remains required regardless of package size."));
    } else if (d.surface < 80) {
      checks.push(chk("Font Size & Legibility","PASS",0.75,`Package surface ${d.surface} cm² (<80 cm²): reduced minimum x-height of 0.9mm applies under Art. 13(3).`,"Art. 13(3), Reg. 1169/2011","Minimum x-height is 0.9mm (measured on the lowercase 'e', not overall character height). Product name, net quantity, and ABV (if applicable) must appear in the same field of vision. Art. 13(1) requires clear legibility considering font size, line spacing, stroke width, colour contrast, and surface material."));
    } else {
      checks.push(chk("Font Size & Legibility","PASS",0.75,`Package surface ${d.surface} cm² (≥80 cm²): standard minimum x-height of 1.2mm applies under Art. 13(2).`,"Art. 13(2), Reg. 1169/2011","Minimum x-height is 1.2mm for all mandatory information. Product name, net quantity, and ABV must share the same field of vision. Legibility requirements include appropriate contrast, no text over complex imagery, and sufficient line spacing. Retailer quality standards (BRC, IFS) and some Member State guidelines may impose stricter requirements."));
    }
  }

  // 13. LANGUAGE
  if (d.lang) {
    const markets = (d.markets||"").toUpperCase();
    const langAdvice = [];
    if (markets.includes("NL")||markets.includes("NETHER")) langAdvice.push("NL: Dutch required (Warenwetbesluit informatie levensmiddelen)");
    if (markets.includes("DE")||markets.includes("GERM")) langAdvice.push("DE: German required (LMIV-Durchführungsverordnung)");
    if (markets.includes("FR")||markets.includes("FRAN")) langAdvice.push("FR: French required (Code de la consommation, Art. L. 412-1) - very strictly enforced by DGCCRF");
    if (markets.includes("BE")||markets.includes("BELG")) langAdvice.push("BE: Dutch, French, AND/OR German depending on the region. Brussels: Dutch + French minimum");
    if (markets.includes("IT")||markets.includes("ITAL")) langAdvice.push("IT: Italian required");
    if (markets.includes("ES")||markets.includes("SPAIN")||markets.includes("SPAN")) langAdvice.push("ES: Spanish (Castilian) required");
    if (markets.includes("EU-WIDE")||markets.includes("EU WIDE")) langAdvice.push("EU-wide distribution: multi-language label or market-specific label versions needed");
    checks.push(chk("Language Requirements","FLAG",0.6,`Language(s) declared: ${d.lang}. Art. 15 requires food information in a language easily understood by consumers in the Member State where it is marketed.${langAdvice.length ? "\n\nTarget market requirements:\n" + langAdvice.join("\n") : ""}`,"Art. 15, Reg. 1169/2011",`In practice, for multi-market products, use a multi-language label covering all target markets. All mandatory information must be translated - not just the front of pack. Ingredient lists and allergen declarations must be fully translated (scientific/Latin names alone are not sufficient unless they serve as the legal name). Some Member States may accept English for specific categories but this is not guaranteed - include the national language to be safe.`));
  }

  // 14. QUID
  if (d.quid === "yes") {
    checks.push(chk("QUID","PASS",0.7,"QUID (Quantitative Ingredient Declaration) present. The percentage must be indicated for ingredients that: (a) appear in the product name, (b) are usually associated with the name by consumers, (c) are emphasised on the label by words/pictures/graphics, or (d) are essential to characterise the food.","Art. 22, Annex VIII, Reg. 1169/2011","Check: percentage refers to quantity at time of manufacture (not after cooking/reconstitution). for concentrated/dehydrated products, the percentage may be based on reconstituted product with a note 'based on reconstituted product'. QUID exemptions exist for ingredients used in small quantities for flavouring, drained weight products where the weight is declared, and ingredients where the percentage would not influence the consumer's choice."));
  } else if (d.quid === "unsure" && d.ingredients.length) {
    const nameLow = (d.name||"").toLowerCase();
    const nameIngredients = d.ingredients.filter(i => {
      const ingClean = i.toLowerCase().replace(/\(.*?\)/g,"").trim().split(",")[0].trim();
      return ingClean.length > 2 && nameLow.includes(ingClean);
    });
    const quidHint = nameIngredients.length ? `\nIngredients potentially triggering QUID based on product name "${d.name}": ${nameIngredients.join(", ")}.` : "";
    checks.push(chk("QUID","FLAG",0.65,`QUID applicability uncertain.${quidHint} Art. 22 requires QUID when an ingredient appears in the product name, is highlighted by words or pictures, or is essential to characterise the food.`,"Art. 22, Annex VIII, Reg. 1169/2011",`On your label: any ingredient in the product name needs QUID (e.g. 'Tomato & Basil Soup' → tomato % and basil %). Any ingredient shown in imagery needs QUID (e.g. picture of shrimp on a fish pie → shrimp %). Exceptions: ingredients used in small quantities purely for flavouring, or where the quantity would not influence consumer choice. When in doubt, include QUID - it is rarely penalised as excessive but frequently penalised as missing.`));
  }

  // 15. ORGANIC
  if (d.organic === "yes") {
    checks.push(chk("Organic Certification","FLAG",0.6,"Organic claim present. The term 'organic' (and equivalents: 'bio', 'öko', 'eco' in relevant languages) is legally protected under Reg. 2018/848. Products must be certified by an accredited control body.","Art. 24-25, Art. 30, Reg. 2018/848","The label needs the EU organic leaf logo (mandatory on all EU-produced prepacked organic food), the control body code in 'XX-BIO-XXX' format (e.g. 'NL-BIO-01') in the same visual field as the logo, and an origin indication ('EU Agriculture', 'non-EU Agriculture', or specific country) also in the same visual field. If less than 95% of agricultural ingredients are organic, you cannot use the EU logo or call the product 'organic' - you may only reference individual organic ingredients in the ingredient list. Make sure your own certification is current and that all supplier organic certificates are up to date."));
  }

  // 16. NOVEL FOOD
  if (d.novel === "yes") {
    checks.push(chk("Novel Food Status","FLAG",0.7,"Product contains novel food ingredient(s). Novel foods require pre-market authorisation and inclusion in the Union List (Reg. 2017/2470) before placement on the EU market. Selling an unauthorised novel food is a serious offence carrying product seizure and recall consequences.","Reg. (EU) 2015/2283; Reg. (EU) 2017/2470","Check: check the Union List (Commission Implementing Reg. 2017/2470) for your ingredient - it must be explicitly listed. Comply with any conditions of use specified (maximum levels, target population, specific labelling requirements). If the ingredient is not in the Union List, do not market the product - submit a novel food application to the Commission (EFSA evaluation typically takes 9–18 months). Specific mandatory labelling may include: the designation of the novel food, conditions of use, and warnings for specific population groups as specified in the Union List entry."));
  } else if (d.novel === "unsure") {
    checks.push(chk("Novel Food Status","FLAG",0.5,"Novel food status uncertain. A food is 'novel' if it was not consumed to a significant degree in the EU before 15 May 1997. This covers new sources, new structures, new production processes, and foods from third-country traditional diets without EU consumption history.","Reg. (EU) 2015/2283","Start with the Check the EU Novel Food Catalogue (ec.europa.eu/food/food-feed-portal/screen/novel-food-catalogue/search) - this is indicative, not legally binding. if uncertain, request a formal 'consultation procedure' with the competent authority of the Member State where you intend to first market. common novel food pitfalls: CBD/hemp extracts, edible insects, certain algae species, exotic fruits/seeds without EU consumption history. non-compliance carries severe consequences: product withdrawal, destruction orders, and potential criminal prosecution in some Member States."));
  }

  // 17. GMO
  if (d.gmo === "yes") {
    checks.push(chk("GMO Declaration","FLAG",0.7,"Product contains or is produced from GMOs. Labelling is mandatory when GMO content exceeds the 0.9% threshold per ingredient (below 0.9% is exempt only if presence is adventitious or technically unavoidable and the operator can demonstrate traceability efforts).","Reg. (EC) 1829/2003, 1830/2003","Label wording: 'This product contains genetically modified [organism name]' or 'produced from genetically modified [organism name]'. Placement: (1) in the ingredient list immediately after the relevant ingredient. or in a footnote linked to the ingredient if space is limited. Maintain traceability documentation (unique identifiers, records of GMO status transmission at each supply chain stage) for 5 years as required by Reg. 1830/2003."));
  } else if (d.gmo === "free") {
    checks.push(chk("GMO-Free Claim","FLAG",0.6,"'GMO-free' labelling is not harmonised at EU level. Some Member States operate national certification schemes with specific criteria.","National legislation (not harmonised)","In Germany: DE: 'Ohne Gentechnik' - managed by VLOG, requires certification, animal feed must also be non-GMO for a defined period prior to production. AT: 'Gentechnik-frei erzeugt' - similar to DE scheme. FR: 'sans OGM' - governed by Decree 2012-128, threshold <0.1% per ingredient. Warning: a generic 'GMO-free' claim may be considered misleading for products where no GMO equivalent exists in the market (e.g. 'GMO-free mineral water' or 'GMO-free salt') - some enforcement authorities actively challenge such claims."));
  }

  // 17b. FOOD SUPPLEMENT SPECIFIC (Dir. 2002/46/EC)
  if (d.category === "Supplement") {
    const suppNotes = d.notes || "";
    const hasDesignation = suppNotes.toLowerCase().includes("food supplement") || (d.name||"").toLowerCase().includes("supplement");
    const hasDoseWarning = suppNotes.toLowerCase().includes("exceed") || suppNotes.toLowerCase().includes("dose") || suppNotes.toLowerCase().includes("recommended daily");
    const hasChildWarning = suppNotes.toLowerCase().includes("children") || suppNotes.toLowerCase().includes("child") || suppNotes.toLowerCase().includes("reach");
    const hasDietStatement = suppNotes.toLowerCase().includes("varied") || suppNotes.toLowerCase().includes("balanced diet");

    const missing = [];
    if (!hasDesignation) missing.push("'Food supplement' designation (Art. 6(1))");
    if (!hasDoseWarning) missing.push("Recommended daily dose warning: 'Do not exceed the stated recommended daily dose' (Art. 6(3)(a))");
    if (!hasChildWarning) missing.push("'Keep out of reach of young children' or equivalent (Art. 6(3)(b))");
    if (!hasDietStatement) missing.push("Statement that supplements should not be used as a substitute for a varied diet (Art. 6(3)(c))");

    if (missing.length) {
      checks.push(chk("Food Supplement Requirements","FLAG",0.8,`Food supplement detected. Dir. 2002/46/EC imposes specific labelling requirements beyond general FIC rules. The following mandatory elements could not be confirmed from the information entered:\n${missing.join("\n")}`,"Art. 6, Dir. 2002/46/EC; Art. 9, Reg. 1169/2011",`Food supplement labels must carry all of the following: 'Food supplement' as the product designation (on the label itself, not just marketing copy), the names and amounts of characterising substances per recommended daily portion, the portion itself in measurable terms (e.g. '1 tablet', '2 capsules'), the 'do not exceed' dose warning, the 'keep out of reach of young children' warning, the 'not a substitute for a varied and balanced diet' statement, and vitamin/mineral amounts expressed as % of Reference Intake (Annex XIII, Reg. 1169/2011). Also check whether your target Member States require national notification - Belgium (SPF Santé), Italy (Ministero della Salute), and France (DGCCRF via Téléicare) all do.`));
    } else {
      checks.push(chk("Food Supplement Requirements","PASS",0.7,"Food supplement category selected. Key Dir. 2002/46/EC mandatory statements appear to be referenced in the notes field.","Art. 6, Dir. 2002/46/EC","On the label, ensure you have: 'Food supplement' designation, names and amounts of characterising substances per daily portion, the recommended daily portion, 'Do not exceed' warning, 'Keep out of reach' warning, 'Not a substitute for a varied diet' statement, and vitamin/mineral amounts as % RI. Also check: national notification requirements (BE: SPF Santé, IT: Ministero della Salute, FR: DGCCRF via Téléicare) and maximum permitted levels where national limits exist - there are no EU-wide harmonised maximums yet for most vitamins and minerals."));
    }
  }

  // 18. COUNTRY OF ORIGIN
  const originMandatoryCats = ["Meat","Fish_seafood","Fruit_veg","Dairy"];
  if (d.origin) {
    const hasProv = d.provenance && d.provenance.trim();
    checks.push(chk("Country of Origin","PASS",0.8,`Origin declared: ${d.origin}.${hasProv ? " Place of provenance: "+d.provenance+"." : ""} Under Reg. 2018/775, if the origin of the primary ingredient differs from the product's declared origin, this must be indicated.`,"Art. 26, Reg. 1169/2011; Reg. 2018/775",`Make sure 'origin' refers to where the product underwent its last substantial transformation (customs code rules per Reg. 952/2013). If you declare a specific country of origin (e.g. 'Product of the Netherlands') but the primary ingredient comes from elsewhere, you must state either 'Primary ingredient: [country]' or 'Primary ingredient does not originate from [declared country]' per Reg. 2018/775. Check whether branding or imagery implies a specific origin - a Dutch windmill on a product made with German milk requires origin disclosure. For multi-ingredient products, track primary ingredient origin through your supply chain.`));
  } else if (originMandatoryCats.includes(d.category)) {
    checks.push(chk("Country of Origin","BLOCK",0.85,`Country of origin not provided. MANDATORY for category '${d.category}'.`,"Art. 26, Reg. 1169/2011","Mandatory origin labelling by category: fresh, chilled, or frozen meat of swine/poultry/sheep/goat (Reg. 1337/2013) requires 'Reared in:' and 'Slaughtered in:'. Beef (Reg. 1760/2000) requires 'Born in:', 'Reared in:', 'Slaughtered in:'. Honey, olive oil, fresh fruit/vegetables, and wine all have mandatory origin requirements. Fish and seafood (Reg. 1379/2013) require catch area (FAO zone), production method (caught/farmed), and both common and scientific species name."));
  } else {
    checks.push(chk("Country of Origin","FLAG",0.6,"Country of origin not declared. While not always mandatory, Art. 26(2)(a) requires origin labelling wherever omission could mislead the consumer - particularly when product presentation suggests a different origin than the actual one.","Art. 26, Reg. 1169/2011; Reg. 2018/775","Consider: (1) does the brand name, imagery, flag, crest, or language on the label imply a specific country? If so, actual origin must be stated. Even without mandatory requirements, voluntarily declaring origin builds consumer trust and is increasingly expected by retailers. If origin varies by batch, use 'Produced in the EU' or specify the range of possible origins."));
  }

  // ── Classify each check by truth-type ──
  // structural: decidable from input data alone (mandatory fields, thresholds)
  // trigger: applicability logic (does the rule even apply?)
  // evidence: needs external data to resolve (lab analysis, physical label, national law)
  // interpretive: consumer perception / Art. 7 misleadingness risk
  const typeMap = {
    "Product Name": "structural", "Net Quantity": "structural", "Food Business Operator": "structural",
    "Ingredient List": "structural", "Allergen Declaration": "structural", "Date Marking": "structural",
    "Lot Identification": "structural", "Nutrition Declaration": "structural", "ABV Declaration": "structural",
    "Spirit Category ABV": "structural", "Font Size & Legibility": "evidence",
    "Language Requirements": "evidence", "Country of Origin": "trigger",
    "QUID": "trigger", "Annex III Warnings": "structural",
    "Health Claims": "trigger", "Nutrition Claims": "trigger",
    "Marketing Claims": "interpretive", "Claims": "trigger",
    "Nutri-Score Estimate": "evidence",
    "Geographic Indication": "evidence", "Organic Certification": "evidence",
    "Novel Food Status": "trigger", "GMO Declaration": "structural",
    "GMO-Free Claim": "interpretive", "Food Supplement Requirements": "trigger",
  };
  checks.forEach(c => { if (!c.type || c.type === "structural") c.type = typeMap[c.name] || "structural"; });

  return checks;
}

// ══════════════════════════════════════════════════════════════════
// RUN
// ══════════════════════════════════════════════════════════════════
let lastReport = null;

function runCheck() {
  const d = gatherData();
  if (!d.name) { alert("Please enter a product name."); return; }

  const checks = runChecks(d);
  const pass = checks.filter(c=>c.result==="PASS").length;
  const flag = checks.filter(c=>c.result==="FLAG").length;
  const block = checks.filter(c=>c.result==="BLOCK").length;
  let risk = Math.min(block*25 + flag*8, 100);

  // Consequence archetypes - what would an enforcement authority do?
  const archetypes = [];
  const structBlocks = checks.filter(c=>c.result==="BLOCK"&&(c.type==="structural"||c.type==="trigger"));
  const allergenIssues = checks.filter(c=>c.name.includes("Allergen")&&c.result==="BLOCK");
  const safetyIssues = checks.filter(c=>(c.name.includes("Allergen")||c.name.includes("Annex III")||c.name.includes("Date Marking"))&&c.result==="BLOCK");
  const claimIssues = checks.filter(c=>(c.name.includes("Claim")||c.name.includes("Nutri"))&&c.result!=="PASS");
  const marketingRisk = checks.filter(c=>c.type==="interpretive"&&c.result==="FLAG");
  const originGI = checks.filter(c=>(c.name.includes("Origin")||c.name.includes("Geographic")||c.name.includes("Organic"))&&c.result==="BLOCK");
  const evidenceNeeded = checks.filter(c=>c.type==="evidence"&&c.result==="FLAG");

  if (safetyIssues.length) archetypes.push({ label:"Health protection risk", desc:"Allergen or safety warning gap found. This type of finding can lead to RASFF notifications and product recalls. Resolve before any market placement." });
  if (structBlocks.length && !safetyIssues.length) archetypes.push({ label:"Marketability stop risk", desc:"Mandatory information is missing. An inspector encountering this label would likely issue a corrective action notice until the label is amended." });
  if (originGI.length) archetypes.push({ label:"Fraud / authenticity scrutiny risk", desc:"Origin, GI, or organic certification issue detected. Several Member States have dedicated fraud units that investigate these discrepancies." });
  if (marketingRisk.length) archetypes.push({ label:"Misleadingness dispute risk", desc:"One or more marketing claims fall in the interpretive zone under Art. 7 or the Unfair Commercial Practices Directive. Review with a regulatory specialist is recommended." });
  if (claimIssues.length && !safetyIssues.length && !structBlocks.length) archetypes.push({ label:"Claims review required", desc:"Nutrition or health claims present that require verification against the Annex conditions or the EU Register. A common source of enforcement findings." });
  if (flag && !block && !archetypes.length) archetypes.push({ label:"Administrative correction likely", desc:"Minor formatting, language, or presentation items. Typically noted by inspectors but unlikely to result in market withdrawal." });
  if (evidenceNeeded.length) archetypes.push({ label:"Evidence required", desc:`${evidenceNeeded.length} finding(s) depend on information this tool cannot verify: laboratory analysis, physical label measurements, or national implementing rules.` });
  if (!archetypes.length) archetypes.push({ label:"No enforcement issues detected", desc:"Nothing flagged from the information provided. A physical label review remains good practice before committing to a print run." });

  let verdict, vClass;
  if (block) { verdict = "CANNOT PROCEED - Critical non-compliance issues require resolution"; vClass = "v-block"; }
  else if (flag >= 4) { verdict = "EXPERT REVIEW REQUIRED - Multiple items need professional assessment"; vClass = "v-flag"; }
  else if (flag) { verdict = "CONDITIONAL PASS - Minor issues to address before market placement"; vClass = "v-flag"; }
  else { verdict = "NO ISSUES DETECTED - Manual label review still recommended"; vClass = "v-pass"; }

  const now = new Date();
  const id = `CR-${now.toISOString().slice(0,10).replace(/-/g,"")}-${String(Math.floor(Math.random()*999)+1).padStart(3,"0")}`;
  lastReport = { id, date: now.toISOString().slice(0,10), product: d, checks, pass, flag, block, risk, verdict, archetypes };

  renderResults(lastReport, vClass);
}

function renderResults(r, vClass) {
  const panel = document.getElementById("resultsPanel");
  panel.classList.add("visible");
  document.getElementById("rptId").textContent = r.id + " | " + r.date;

  // Archetype icon styles (minimalist circles, no emoji)
  const arcIcons = {
    "Health protection risk": { bg:"#fef2f2", border:"#dc2626", dot:"#dc2626" },
    "Marketability stop risk": { bg:"#fff7ed", border:"#ea580c", dot:"#ea580c" },
    "Fraud / authenticity scrutiny risk": { bg:"#faf5ff", border:"#7c3aed", dot:"#7c3aed" },
    "Misleadingness dispute risk": { bg:"#fffbeb", border:"#d97706", dot:"#d97706" },
    "Claims review required": { bg:"#fffbeb", border:"#d97706", dot:"#d97706" },
    "Administrative correction likely": { bg:"#eff6ff", border:"#2563eb", dot:"#2563eb" },
    "Evidence required": { bg:"#f0f9ff", border:"#0369a1", dot:"#0369a1" },
    "No enforcement issues detected": { bg:"#f0fdf4", border:"#16a34a", dot:"#16a34a" },
  };
  const arcHTML = (r.archetypes||[]).map(a => {
    const s = arcIcons[a.label] || { bg:"#f6f7f9", border:"#9ca3af", dot:"#9ca3af" };
    return `<div style="display:flex;align-items:start;gap:10px;padding:10px 14px;background:${s.bg};border-radius:var(--r);border:1px solid ${s.border}22;border-left:3px solid ${s.border}"><div style="width:8px;height:8px;border-radius:50%;background:${s.dot};flex-shrink:0;margin-top:5px"></div><div><div style="font-size:13px;font-weight:600;color:${s.dot}">${a.label}</div><div style="font-size:12px;color:var(--text-2)">${a.desc}</div></div></div>`;
  }).join("");

  // Score-first layout, colour-coded stat cards
  const riskColor = r.risk >= 50 ? "var(--block)" : r.risk >= 20 ? "var(--flag)" : "var(--pass)";
  document.getElementById("summaryGrid").innerHTML = `
    <div class="stat-card" style="border-top:3px solid ${riskColor}"><div class="stat-label">Triage Score</div><div class="stat-val" style="color:${riskColor}">${r.risk}</div><div class="stat-sub">/ 100</div></div>
    <div class="stat-card" style="border-top:3px solid var(--block)"><div class="stat-label">Critical</div><div class="stat-val" style="color:var(--block)">${r.block}</div><div class="stat-sub">must resolve</div></div>
    <div class="stat-card" style="border-top:3px solid var(--flag)"><div class="stat-label">Flagged</div><div class="stat-val" style="color:var(--flag)">${r.flag}</div><div class="stat-sub">review needed</div></div>
    <div class="stat-card" style="border-top:3px solid var(--pass)"><div class="stat-label">Passed</div><div class="stat-val" style="color:var(--pass)">${r.pass}</div><div class="stat-sub">checks</div></div>
    <div style="grid-column:1/-1;display:flex;flex-direction:column;gap:6px;margin-top:4px">${arcHTML}</div>
  `;

  document.getElementById("verdictBar").innerHTML = `<div class="verdict-bar ${vClass}">${r.verdict}</div>`;

  // Truth-type label + colour
  const typeLabel = { structural:"Structural", trigger:"Trigger", evidence:"Evidence", interpretive:"Interpretive" };
  const typeColor = { structural:"#6b7280", trigger:"#7c3aed", evidence:"#0369a1", interpretive:"#c2410c" };

  const list = document.getElementById("checksList");
  list.innerHTML = "";
  r.checks.forEach(c => {
    const ic = c.result==="PASS"?"pass":c.result==="FLAG"?"flag":c.result==="BLOCK"?"block":"na";
    const sym = c.result==="PASS"?"✓":c.result==="FLAG"?"!":c.result==="BLOCK"?"✕":"—";
    const tt = c.type || "structural";
    const div = document.createElement("div");
    div.className = "chk";
    div.innerHTML = `
      <div class="chk-head" onclick="this.parentElement.classList.toggle('open')">
        <div class="chk-icon ${ic}">${sym}</div>
        <div class="chk-info"><div class="chk-name">${c.name} <span style="font-size:10px;font-weight:500;color:${typeColor[tt]};background:${typeColor[tt]}12;padding:1px 6px;border-radius:3px;margin-left:6px;vertical-align:middle;letter-spacing:0.3px">${typeLabel[tt]}</span></div><div class="chk-preview">${c.reasoning.slice(0,90)}${c.reasoning.length>90?"...":""}</div></div>
        <div class="chk-conf">${(c.conf*100).toFixed(0)}%</div>
      </div>
      <div class="chk-body">
        <div class="chk-row"><strong>Finding</strong><span>${c.reasoning.replace(/\n/g,"<br>")}</span></div>
        ${c.ref ? `<div class="chk-row"><strong>Legal Basis</strong><span>${linkifyRef(c.ref)}</span></div>` : ""}
        ${c.rec ? `<div class="chk-row"><strong>Recommendation</strong><span>${c.rec}</span></div>` : ""}
      </div>
    `;
    list.appendChild(div);
  });

  panel.scrollIntoView({ behavior: "smooth" });
}

function exportJSON() {
  if (!lastReport) return;
  const blob = new Blob([JSON.stringify(lastReport, null, 2)], { type: "application/json" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = lastReport.id + ".json";
  a.click();
}

function generatePDF() {
  if (!lastReport) return;
  const r = lastReport;
  const statusLabel = s => s==="PASS"?"PASS":s==="FLAG"?"FLAG":s==="BLOCK"?"FAIL":"N/A";
  const statusColor = s => s==="PASS"?"#16a34a":s==="FLAG"?"#d97706":s==="BLOCK"?"#dc2626":"#9ca3af";
  const statusBg = s => s==="PASS"?"#f0fdf4":s==="FLAG"?"#fffbeb":s==="BLOCK"?"#fef2f2":"#f6f7f9";

  let checksHTML = r.checks.map(c => `
    <tr>
      <td style="padding:10px 14px;border-bottom:1px solid #e5e7eb">
        <span style="display:inline-block;padding:2px 8px;border-radius:4px;font-size:11px;font-weight:600;background:${statusBg(c.result)};color:${statusColor(c.result)}">${statusLabel(c.result)}</span>
      </td>
      <td style="padding:10px 14px;border-bottom:1px solid #e5e7eb;font-weight:600;font-size:13px;color:#111827">${c.name}</td>
      <td style="padding:10px 14px;border-bottom:1px solid #e5e7eb;font-size:12px;color:#4b5563">${c.reasoning.replace(/\n/g,"<br>")}</td>
    </tr>
    <tr>
      <td style="border-bottom:1px solid #eceef2"></td>
      <td style="padding:4px 14px 10px;border-bottom:1px solid #eceef2;font-size:11px;color:#9ca3af;font-family:'JetBrains Mono',monospace">${c.ref}</td>
      <td style="padding:4px 14px 10px;border-bottom:1px solid #eceef2;font-size:12px;color:#1a8a6e">${c.rec}</td>
    </tr>
  `).join("");

  const verdictColor = r.block ? "#dc2626" : r.flag >= 4 ? "#d97706" : r.flag ? "#d97706" : "#16a34a";

  const html = `<!DOCTYPE html><html><head>
<meta charset="UTF-8">
<title>EU LABEL CHECK - Regulatory Situation Analysis ${r.id}</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400&family=Instrument+Serif:ital@0;1&display=swap" rel="stylesheet">
<style>
@page { size: A4; margin: 20mm 18mm; }
body { font-family: 'DM Sans', system-ui, sans-serif; color: #111827; line-height: 1.5; margin: 0; padding: 0; }
@media print { body { -webkit-print-color-adjust: exact; print-color-adjust: exact; } }
</style>
</head><body>
<div style="padding:40px">
  <!-- HEADER -->
  <div style="display:flex;justify-content:space-between;align-items:start;border-bottom:3px solid #0c2340;padding-bottom:20px;margin-bottom:24px">
    <div>
      <div style="font-size:24px;font-weight:700;color:#0c2340;letter-spacing:-0.3px">EU Label Check</div>
      <div style="font-size:11px;color:#9ca3af;font-family:'JetBrains Mono',monospace;margin-top:2px">Regulatory Situation Analysis</div>
    </div>
    <div style="text-align:right">
      <div style="font-size:12px;font-family:'JetBrains Mono',monospace;color:#4b5563">${r.id}</div>
      <div style="font-size:12px;color:#9ca3af">${r.date}</div>
    </div>
  </div>

  <!-- PRODUCT SUMMARY -->
  <div style="background:#f6f7f9;border-radius:8px;padding:18px 22px;margin-bottom:20px;border:1px solid #e5e7eb">
    <div style="font-size:11px;text-transform:uppercase;letter-spacing:0.8px;color:#9ca3af;font-weight:600;margin-bottom:8px">Product Under Review</div>
    <div style="font-size:20px;font-weight:700;color:#0c2340">${r.product.name}</div>
    <div style="font-size:13px;color:#4b5563;margin-top:4px">${r.product.company}${r.product.category ? " · " + r.product.category : ""}${r.product.subcategory ? " · " + r.product.subcategory : ""}${r.product.qty ? " · " + r.product.qty : ""}${r.product.abv !== null ? " · " + r.product.abv + "% vol" : ""}</div>
    ${r.product.markets ? '<div style="font-size:12px;color:#9ca3af;margin-top:4px">Target markets: ' + r.product.markets + '</div>' : ""}
  </div>

  <!-- CONSEQUENCE ARCHETYPES -->
  <div style="font-size:16px;font-weight:700;color:#0c2340;margin-bottom:10px;padding-bottom:6px;border-bottom:1px solid #e5e7eb">Enforcement Consequence Assessment</div>
  <div style="display:flex;flex-direction:column;gap:6px;margin-bottom:20px">
    ${(r.archetypes||[]).map(a => {
      const colors = {"Health protection risk":"#dc2626","Marketability stop risk":"#ea580c","Fraud / authenticity scrutiny risk":"#7c3aed","Misleadingness dispute risk":"#d97706","Claims review required":"#d97706","Administrative correction likely":"#2563eb","Evidence required":"#0369a1","No enforcement issues detected":"#16a34a"};
      const c = colors[a.label]||"#6b7280";
      return `<div style="padding:8px 14px;background:#f6f7f9;border-radius:6px;border:1px solid #e5e7eb;border-left:3px solid ${c};display:flex;align-items:center;gap:10px"><div style="width:8px;height:8px;border-radius:50%;background:${c};flex-shrink:0"></div><div><span style="font-size:12px;font-weight:600;color:${c}">${a.label}</span> <span style="font-size:11px;color:#6b7280">— ${a.desc}</span></div></div>`;
    }).join("")}
  </div>

  <!-- SCORE SUMMARY -->
  <div style="display:flex;gap:12px;margin-bottom:20px">
    <div style="flex:1;background:#fff;border:1px solid #e5e7eb;border-radius:8px;padding:14px;text-align:center">
      <div style="font-size:10px;text-transform:uppercase;letter-spacing:0.6px;color:#9ca3af;font-weight:600">Triage Score</div>
      <div style="font-size:28px;font-weight:700;color:#0c2340;font-family:'JetBrains Mono',monospace">${r.risk}</div>
      <div style="font-size:10px;color:#9ca3af">/ 100</div>
    </div>
    <div style="flex:1;background:#fff;border:1px solid #e5e7eb;border-radius:8px;padding:14px;text-align:center">
      <div style="font-size:10px;text-transform:uppercase;letter-spacing:0.6px;color:#9ca3af;font-weight:600">Passed</div>
      <div style="font-size:28px;font-weight:700;color:#16a34a;font-family:'JetBrains Mono',monospace">${r.pass}</div>
    </div>
    <div style="flex:1;background:#fff;border:1px solid #e5e7eb;border-radius:8px;padding:14px;text-align:center">
      <div style="font-size:10px;text-transform:uppercase;letter-spacing:0.6px;color:#9ca3af;font-weight:600">Flagged</div>
      <div style="font-size:28px;font-weight:700;color:#d97706;font-family:'JetBrains Mono',monospace">${r.flag}</div>
    </div>
    <div style="flex:1;background:#fff;border:1px solid #e5e7eb;border-radius:8px;padding:14px;text-align:center">
      <div style="font-size:10px;text-transform:uppercase;letter-spacing:0.6px;color:#9ca3af;font-weight:600">Critical</div>
      <div style="font-size:28px;font-weight:700;color:#dc2626;font-family:'JetBrains Mono',monospace">${r.block}</div>
    </div>
  </div>

  <!-- VERDICT -->
  <div style="padding:12px 18px;border-radius:8px;border-left:4px solid ${verdictColor};background:${r.block ? '#fef2f2' : r.flag ? '#fffbeb' : '#f0fdf4'};font-size:14px;font-weight:600;color:${verdictColor};margin-bottom:24px">
    ${r.verdict}
  </div>

  <!-- DETAILED FINDINGS -->
  <div style="font-size:16px;font-weight:700;color:#0c2340;margin-bottom:12px;padding-bottom:8px;border-bottom:1px solid #e5e7eb">Detailed Findings</div>
  <table style="width:100%;border-collapse:collapse;font-size:13px">
    <thead>
      <tr style="background:#f6f7f9">
        <th style="padding:8px 14px;text-align:left;font-size:11px;text-transform:uppercase;letter-spacing:0.5px;color:#9ca3af;font-weight:600;width:60px">Status</th>
        <th style="padding:8px 14px;text-align:left;font-size:11px;text-transform:uppercase;letter-spacing:0.5px;color:#9ca3af;font-weight:600;width:160px">Check</th>
        <th style="padding:8px 14px;text-align:left;font-size:11px;text-transform:uppercase;letter-spacing:0.5px;color:#9ca3af;font-weight:600">Finding</th>
      </tr>
    </thead>
    <tbody>${checksHTML}</tbody>
  </table>

  <!-- FOOTER -->
  <div style="margin-top:32px;padding-top:16px;border-top:2px solid #0c2340;display:flex;justify-content:space-between;align-items:end">
    <div>
      <div style="font-size:13px;font-weight:700;color:#0c2340">EU Label Check</div>
      <div style="font-size:11px;color:#9ca3af;margin-top:2px">EU Food Label Regulatory Screening</div>
      <div style="font-size:11px;color:#9ca3af">&copy; 2026 Daniil Smetanca · MSc Food Safety, Wageningen University &amp; Research</div>
    </div>
    <div style="text-align:right;font-size:10px;color:#9ca3af;max-width:320px">
      This report provides regulatory pre-screening only. It separates mechanically decidable findings from those requiring expert judgement. Final responsibility: FBO (Art. 8, Reg. 1169/2011).
    </div>
  </div>
</div>
</body></html>`;

  const w = window.open("", "_blank");
  w.document.write(html);
  w.document.close();
  setTimeout(() => w.print(), 600);
}

// ══════════════════════════════════════════════════════════════════
// EXAMPLES
// ══════════════════════════════════════════════════════════════════
const EXAMPLES = {
  soup: {
    f_name:"Organic Tomato & Basil Soup", f_company:"BioSoep BV", f_cat:"Ready_meal", f_subcat:"Cream soup",
    f_qty:"400 ml", f_pkg:"prepacked", f_abv:"", f_markets:"NL, DE, BE",
    f_op_name:"BioSoep BV", f_op_addr:"Keizersgracht 220, 1016 DZ Amsterdam, NL",
    f_origin:"Netherlands", f_provenance:"", f_lot:"L2025-0312", f_date_type:"bbd",
    f_storage:"Keep refrigerated (2-7°C). Once opened, consume within 2 days.", f_instructions:"Heat gently. Do not boil.",
    f_lang:"Dutch, English", f_surface:"180",
    f_ingredients:"Water, Tomatoes (35%), CREAM (MILK) (10%), Onion, Olive oil, Sugar, Salt, Garlic, Basil (1.5%), Black pepper, Citric acid (E330)",
    f_quid:"yes", allergens:["milk"],
    f_nutri_provided:"yes", f_nutri_per:"100ml", f_n_kj:"230", f_n_kcal:"55", f_n_fat:"3.2", f_n_sat:"1.8", f_n_carb:"4.8", f_n_sugar:"3.1", f_n_prot:"1.2", f_n_salt:"0.65",
    f_n_fibre:"", f_n_fvn:"60", f_n_vitD:"", f_n_vitC:"", f_n_calcium:"", f_n_iron:"", f_n_vitB12:"", f_n_folate:"", f_n_zinc:"", f_n_potassium:"",
    f_claims:"Organic, No artificial colours or flavours", f_gi:"no", f_gi_name:"", f_organic:"yes", f_novel:"no", f_gmo:"no", f_notes:""
  },
  cheese: {
    f_name:"Gouda Holland Aged 12 Months", f_company:"Kaasmakerij Van der Berg", f_cat:"Dairy", f_subcat:"Hard cheese",
    f_qty:"300 g", f_pkg:"prepacked", f_abv:"", f_markets:"NL, DE, FR, EU-wide",
    f_op_name:"Kaasmakerij Van der Berg BV", f_op_addr:"Zuivelweg 15, 2801 AB Gouda, NL",
    f_origin:"Netherlands", f_provenance:"Gouda region", f_lot:"L2025-0198", f_date_type:"bbd",
    f_storage:"Keep refrigerated (4-8°C)", f_instructions:"",
    f_lang:"Dutch, English, French, German", f_surface:"250",
    f_ingredients:"Pasteurised cow's MILK, Salt, Starter cultures, Rennet, Annatto (E160b)",
    f_quid:"no", allergens:["milk"],
    f_nutri_provided:"yes", f_nutri_per:"100g", f_n_kj:"1580", f_n_kcal:"380", f_n_fat:"30.5", f_n_sat:"19.8", f_n_carb:"0.1", f_n_sugar:"0.1", f_n_prot:"25.5", f_n_salt:"2.8",
    f_n_fibre:"0", f_n_fvn:"0", f_n_vitD:"", f_n_vitC:"", f_n_calcium:"820", f_n_iron:"", f_n_vitB12:"", f_n_folate:"", f_n_zinc:"", f_n_potassium:"",
    f_claims:"Source of calcium, High in protein", f_gi:"pgi", f_gi_name:"Gouda Holland", f_organic:"no", f_novel:"no", f_gmo:"no", f_notes:""
  },
  gin: {
    f_name:"Amsterdam Botanical Gin", f_company:"De Stadsbrouwerij BV", f_cat:"Spirit", f_subcat:"Gin",
    f_qty:"700 ml", f_pkg:"prepacked", f_abv:"42", f_markets:"NL, DE, BE",
    f_op_name:"De Stadsbrouwerij BV", f_op_addr:"Herengracht 100, 1015 Amsterdam, NL",
    f_origin:"Netherlands", f_provenance:"", f_lot:"L2024-0842", f_date_type:"exempt",
    f_storage:"", f_instructions:"", f_lang:"English, Dutch", f_surface:"300",
    f_ingredients:"Grain spirit, Juniper berries, Coriander seeds, Angelica root, Orange peel, Lemon peel, Orris root, Cassia bark, ALMONDS, Liquorice root, Water",
    f_quid:"no", allergens:["tree_nuts"],
    f_nutri_provided:"exempt", f_nutri_per:"100ml", f_n_kj:"", f_n_kcal:"", f_n_fat:"", f_n_sat:"", f_n_carb:"", f_n_sugar:"", f_n_prot:"", f_n_salt:"",
    f_n_fibre:"", f_n_fvn:"", f_n_vitD:"", f_n_vitC:"", f_n_calcium:"", f_n_iron:"", f_n_vitB12:"", f_n_folate:"", f_n_zinc:"", f_n_potassium:"",
    f_claims:"Small batch, Handcrafted", f_gi:"no", f_gi_name:"", f_organic:"no", f_novel:"no", f_gmo:"no", f_notes:""
  },
  supplement: {
    f_name:"Vitamin D3 2000 IU Tablets", f_company:"VitalNutra BV", f_cat:"Supplement", f_subcat:"Vitamin supplement",
    f_qty:"90 tablets (45 g)", f_pkg:"prepacked", f_abv:"", f_markets:"NL, DE, BE, FR",
    f_op_name:"VitalNutra BV", f_op_addr:"Innovatieweg 8, 3542 DZ Utrecht, NL",
    f_origin:"Netherlands", f_provenance:"", f_lot:"L2025-VD-088", f_date_type:"bbd",
    f_storage:"Store in a cool, dry place. Keep out of reach of children.", f_instructions:"Take 1 tablet daily with a meal.",
    f_lang:"Dutch, English, French, German", f_surface:"60",
    f_ingredients:"Bulking agent (Microcrystalline cellulose), Cholecalciferol (Vitamin D3), Anti-caking agents (Magnesium stearate, Silicon dioxide), Coating agent (Hydroxypropyl methylcellulose)",
    f_quid:"no", allergens:[],
    f_nutri_provided:"exempt", f_nutri_per:"100g", f_n_kj:"", f_n_kcal:"", f_n_fat:"", f_n_sat:"", f_n_carb:"", f_n_sugar:"", f_n_prot:"", f_n_salt:"",
    f_n_fibre:"", f_n_fvn:"", f_n_vitD:"50", f_n_vitC:"", f_n_calcium:"", f_n_iron:"", f_n_vitB12:"", f_n_folate:"", f_n_zinc:"", f_n_potassium:"",
    f_claims:"Supports immune function, Contributes to normal bone health", f_gi:"no", f_gi_name:"", f_organic:"no", f_novel:"no", f_gmo:"no",
    f_notes:"Must include: 'Food supplement' designation, recommended daily dose, warning not to exceed dose, statement about varied diet, keep out of reach of children."
  }
};

function loadExample(key) {
  clearAll();
  const ex = EXAMPLES[key];
  for (const [id, val] of Object.entries(ex)) {
    if (id === "allergens") {
      document.querySelectorAll('#allergenGrid input').forEach(cb => cb.checked = val.includes(cb.value));
      continue;
    }
    const el = document.getElementById(id);
    if (el) el.value = val;
  }
  // Auto-run compliance check so user sees results immediately
  setTimeout(() => runCheck(), 150);
}

function clearAll() {
  document.querySelectorAll('input, textarea').forEach(el => el.value = "");
  document.querySelectorAll('select').forEach(el => el.selectedIndex = 0);
  document.querySelectorAll('#allergenGrid input').forEach(cb => cb.checked = false);
  document.querySelectorAll('.allergen-item').forEach(el => el.classList.remove('detected'));
  document.getElementById("resultsPanel").classList.remove("visible");
  lastReport = null;
  updateProgress();
}

// Tab progress indicators
function updateProgress() {
  const v = id => (document.getElementById(id)?.value||"").trim();
  const td = (n, filled) => { const el=document.getElementById("td"+n); if(el) el.classList.toggle("filled", filled); };
  td(0, !!(v("f_name") || v("f_company") || v("f_cat")));
  td(1, !!(v("f_op_name") || v("f_lot") || v("f_date_type")));
  td(2, !!(v("f_ingredients") || document.querySelector('#allergenGrid input:checked')));
  td(3, !!(v("f_nutri_provided") && v("f_nutri_provided") !== "no"));
  td(4, !!(v("f_claims") || v("f_organic")==="yes" || v("f_novel")!=="no"));
}

// Listen for changes across all form elements
document.querySelectorAll('input, textarea, select').forEach(el => {
  el.addEventListener('input', updateProgress);
  el.addEventListener('change', updateProgress);
});
</script>
</body>
</html>
